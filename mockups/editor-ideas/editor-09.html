<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <title>
      OERPub Editor
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <script src="helper_files/jquery-1.8.2.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.core.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.position.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.widget.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.mouse.min.js" type="text/javascript"></script>
    <script src="helper_files/draggable.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.droppable.js" type="text/javascript"></script>
    <script src="helper_files/scrollto.js" type="text/javascript"></script>
    <script src="helper_files/jquery.simplemodal.1.4.1.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.ui.dialog.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.effects.core.min.js" type="text/javascript"></script>
    <script src="helper_files/jquery.effects.highlight.min.js" type="text/javascript"></script>
    <script src="helper_files/googlejsapi.js" type="text/javascript"></script>
<!--
    <script src="helper_files/swordpush.js" type="text/javascript"></script>
-->
    <script src="helper_files/swordpush-max-03.js" type="text/javascript"></script>
    <script src="helper_files/hoverIntent.js" type="text/javascript"></script>
    <script src="helper_files/jquery.livequery.js" type="text/javascript"></script>
<!--
    <script src="helper_files/jquery.ui.resizable.min.js" type="text/javascript"></script>
-->
    <script src="helper_files/jquery.mousestop.js" type="text/javascript"></script>
<!--
    <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
-->
<!--
    <script type="text/javascript" src="http://cnx.org/++resource++mathjax/MathJax.js">
            MathJax.Hub.Config({
                extensions: ["mml2jax-bugfix.js"],
                menuSettings: {zoom:"Click"},
                "HTML-CSS": {scale:110},
                jax: ["input/MathML","output/HTML-CSS"]
            });
            if(location.href.split("#").length != 1) {
              MathJax.Hub.Register.StartupHook("End", function() {location.href = location.href; });
            }
    </script>
-->
    <script src="helper_files/ASCIIMathMLwFallback.js" type="text/javascript"></script>
    <script src="helper_files/ASCIIMathMLeditor.js" type="text/javascript"></script>
    <script src="helper_files/ASCIIMathMLcustomisations.js" type="text/javascript"></script>

    <!-- Max writes: This doesn't need to be the Connexions X ... but it was useful to have something there when making these mock-ups. -->
    <link rel="shortcut icon" type="image/x-icon" href="helper_files/favicon.ico" />

<link type="text/css" href="content_files/document-in-oerpub-01.css" media="screen" title="newlook" rel="stylesheet"/>

<!--
    <link rel="stylesheet" href="helper_files/main.css" type="text/css" media="screen" charset="utf-8" />
-->
    <link rel="stylesheet" href="helper_files/main-max-04.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="helper_files/ui-theme-base/jquery.ui.all.css" type="text/css" media="screen" charset="utf-8" />
    <!--[if IE 6]>
    <link rel="stylesheet" href="helper_files/ie6.css" type="text/css" media="screen" charset="utf-8" />
    <![endif]-->

<script type="text/javascript">

$(window).resize(function(){

  var winh = $(window).height();
  var headerh = $("#header-container").outerHeight();
  var wfnh = $("#workflownav-wrap").outerHeight();
  var contentp = parseInt($("#content").css("paddingTop"));
  var contentp = contentp + parseInt($("#content").css("paddingBottom"));
  var phwh = $("#pageheader-wrap").outerHeight();
  var ma = $("#module-actions .advanced").outerWidth();
/*
  var cmt = parseInt($("#canvas").css("marginTop"));
  var cpt = parseInt($("#canvas").css("paddingTop"));
*/

  // Make the editor fit exactly inside the remaining space
//  $("#editor").height(winh - headerh - wfnh - contentp - phwh + 10);
//  $("#artboard").height(winh - headerh - wfnh - contentp - phwh + 10 - 46 - cmt - cpt*2);
//  $("#artboard").height(winh - headerh - wfnh - contentp - phwh + 10 - 44);
  $("#artboard").height(winh - 43);
  $("#editor").width($(window).width() - 0);

});


$(document).ready(function(){

/* Moved this portion back directly into the file because 'headerh' wasn't always correctly calculated when done from the external file. */

  var winh = $(window).height();
  var headerh = $("#header-container").outerHeight();
  var wfnh = $("#workflownav-wrap").outerHeight();
  var contentp = parseInt($("#content").css("paddingTop"));
  var contentp = contentp + parseInt($("#content").css("paddingBottom"));
  var phwh = $("#pageheader-wrap").outerHeight();
  var ma = $("#module-actions .advanced").outerWidth();

  // Make the editor fit exactly inside the remaining space
//  $("#editor").height(winh - headerh - wfnh - contentp - phwh + 10);
//  $("#artboard").height(winh - headerh - wfnh - contentp - phwh + 10 - 44);
//  $("#editor").height(winh - 30);
//  $("#artboard").height(winh - 43);
  $("#artboard").css("margin-top",$('#toolbar').outerHeight() + "px");
  $("#editor").width($(window).width() - 0);

  // Give the page's header the correct top margin (since the elements above it are in a fixed position)
//  $("#content").css({'margin-top': headerh + wfnh})


  $(".toolbar-function").not(".disabled").find(".toolbar-icon").hover(function(e){
      $(this).closest(".toolbar-function").addClass("hovered");
  }, function(e){
      $(this).closest(".toolbar-function").removeClass("hovered");
  });

  $("#toolbar-table").hoverIntent({
    over: function(e){
//      selectIcon($(this),aol,e);
    }, 
    out: function(e){
        unSelectIcon($(this),e);
    },
    timeout: 300,
  });

  $(".toolbar-icon").click(function(e){
    fn = $(this).closest(".toolbar-function");
    if (fn.not(".disabled")) {
      if (fn.hasClass("selected")) {
        unSelectIcon(fn,e);
      } else {
        selectIcon(fn,aol,e);
      }
    }
    return false;
  });

  $("#include-row-header, label[for='include-row-header']").live("click", function(e){
    if ($(this).is(":checked")) {
      $("#table-flyout-flyout tr:first-child td").each(function(e){
        $(this).addClass("header")
      });
    } else {
      $("#table-flyout-flyout tr:first-child td").each(function(e){
        $(this).removeClass("header")
      });
    }
    e.stopPropagation();
  });

  function activateTableTemp() {
    $("#TableNew").addClass("activated");
  }
  function disActivateTableTemp() {
    $("#TableNew").removeClass("activated");
  }

  $("#table-flyout-flyout td").live("mouseenter", function(e){
    tfEnter($(this),e);
  });
  function tfEnter(td,e) {
    activateTableTemp();
    tfLeave(td.closest("table"),e);
    var curCol = td.index() + 1;
    var curRow = td.closest("tr").index() + 1;
    var totCols = td.siblings().length + 1;
    var totRows = td.closest("tbody").find("tr").length;
    // Remove rows if going upwards with 6+ rows
    if (curRow > 4 && totRows - curRow > 1) {
      td.closest("tbody").find("tr").last().remove();
    }
    // Remove columns if going left with 6+ columns
    if (curCol > 4 && totCols - curCol > 1) {
      td.closest("tbody").find("tr").each(function(e){
        $(this).find("td").last().remove();
      });
    }
    for (i=0; i<curRow; i++) {
      td.closest("tbody").children("tr").eq(i).each(function(e){
        for (j=0; j<curCol; j++) {
          $(this).find("td").eq(j).addClass("hovered");
        }
      });
    }
    // Add a new row to expand
    if (curRow > totRows - 1) {
      var newRows = '';
      for(k=0; k<totCols; k++) {
        newRows = newRows + "<td>&nbsp\;</td>";
      }
      td.closest("tbody").append("<tr>" + newRows + "</tr>");
      totRows++;
    }
    // Add a new column to expand
    if (curCol > totCols - 1) {
      td.closest("tbody").children("tr").each(function(e){
        if( $(this).index() == 0 && $("#include-row-header").is(":checked") ) {
          $(this).append('<td class="header">&nbsp\;</td>');
        } else {
          $(this).append('<td>&nbsp\;</td>');
        }
      });
      totCols++;
    }
    $("#table-dimensions").text(curCol + " x " + curRow);
  }

  $("#table-flyout-flyout table").live("mouseleave", function(e){
    disActivateTableTemp();
    tfLeave($(this),e);
  });
  function tfLeave(table,e) {
    $("#table-dimensions").text("");
    table.find("td").removeClass("hovered");
  }

  $(".toolbar-function.disabled .toolbar-icon").click(function(e){
    e.preventDefault();
  });


  function preventDefault(e){
    e.preventDefault();
  }

  $("#table-flyout-flyout, #table-flyout").live("click", function(e){
    return false;
  });

  $("#table-flyout-flyout td").live("click", function(e){
    var curCol = $(this).index() + 1;
    var curRow = $(this).closest("tr").index() + 1;
    var exText = $(this).closest("#table-flyout").data("exText");
    if( $("#include-row-header").is(":checked") ) {
      var rowHeader = true;
    } else {
      var rowHeader = false;
    }
    newTableFill(curCol,curRow,exText,rowHeader,e);
    unSelectIcon($("#toolbar-table"),e);
    e.stopPropagation();
  });
  
  function newTableFill(dimX,dimY,exText,rowHeader,e) {

    var newTable = '<div class="canvas-wrap" contentEditable="false">\
      <div class="table canvas">\
        <div class="canvas-inner">\
          <table style="border: 1px solid\; width: 100%\;" align="center" cellpadding="0" cellspacing="0" id="TableNew" contentEditable="false">\
            <caption class="table-text" align="bottom">\
              <span class="cnx_label">Table 1&nbsp\;</span>\
              <span class="table-caption content-editable-2" style="display: none;" contentEditable="true">\
                <span class="hint-text">&nbsp;Add a caption (optional)</span>\
              </span>\
            </caption>\
            <colgroup>\
            </colgroup>\
          </table>\
        </div>\
      </div>\
    </div>';

    $("#TableNew").replaceWith(newTable);
    addHandles($("#TableNew").closest(".canvas-wrap"));
    var width = Math.round(100/dimX);
    for (i=0; i<dimX; i++) {
      $("#TableNew colgroup").append('<col width="' + width + '%"/>');
    }
    if (rowHeader == true) {
      $("#TableNew").append("<thead></thead>");
    }
    if (rowHeader == false || dimY > 1) {
      $("#TableNew").append("<tbody></tbody>");
    }
    for (j=0; j<dimY; j++) {
      if (j == 0) {
        if (dimY > 1) {
          addColumns($("#TableNew thead, #TableNew tbody").first(),dimX,dimY,exText,"",e);
        } else {
          addColumns($("#TableNew thead, #TableNew tbody").first(),dimX,dimY,exText,"lastRow",e);
        }
      } else if (j == dimY - 1) {
        addColumns($("#TableNew tbody"),dimX,dimY,"","lastRow",e);
      } else {
        addColumns($("#TableNew tbody"),dimX,dimY,"","",e);
      }
    }
    $("#TableNew").closest(".canvas-wrap");
    $("#TableNew").closest(".canvas-wrap").effect("highlight", { color: "#E5EEF5" }, 1000);
    $("#TableNew th, #TableNew td").first().focus();
    $("#TableNew").removeAttr("id")
    e.stopPropagation();
  }

  function addColumns(location,dimX,dimY,exText,lastRow,e) {

    var cols = '';
    var repText = '';
    var style = 'text-align: left !important\; border-top-width: 0\; border-left-width: 0\; ';
    location.prop("tagName").toLowerCase() == "thead" ? locType = 'th' : locType = 'td';
    for (k=0; k<dimX; k++) {
      k == 0 && exText != "" ? repText = exText : repText = "&nbsp\;";
      if (k == dimX - 1) {
        style+= "border-right-width: 0\; ";
      } else {
        style+= "border-right-width: 1px\; ";
      }
      if (lastRow == "lastRow") {
        style+= "border-bottom-width: 0 !important\;";
      } else {
        style+= "border-bottom-width: 1px\;";
      }
      cols = cols + '<' + locType + ' style="' + style + '" contentEditable="true" class="content-editable">' + repText + '</' + locType + '>';
    }
    location.append('<tr>' + cols + '</tr>');
  }





  $('.canvas-buddy a').mousedown(function(e){
//    $(this).css("cursor","url('content_files/closedhand.cur')");
    $(this).addClass("dragging");
  });
  $('.canvas-buddy a').mouseup(function(e){
//    $(this).css("cursor","url('content_files/openhand.cur')");
    $(this).removeClass("dragging");
  });

  $("#pedagog .node").mousedown(function(e){
    $(this).addClass("dragging");
  });
  $("#pedagog .node").mouseup(function(e){
    $(this).removeClass("dragging");
  });
  $("#pedagog .node").click(function(e){
    var exText = getSelectionText();
    if (exText != '') {
      var elemnum = '';
      var cls = $(this).clone().children().remove().end().text().trim().toLowerCase();
      if (cls == 'numbered equation') cls = 'equation';
      if (cls.indexOf('exercise') > -1) cls = 'exercise';
      if (cls.indexOf('question') > -1) cls = 'question';
      pasteHtmlAtCaret('<div id="SemanticNew" class="canvas-wrap" contenteditable="false"><div class="canvas ' + cls + '"><div class="canvas-inner"><div class="' + cls + '-contents">' + exText + '</div></div></div></div>');
      var snci = $("#SemanticNew .canvas-inner")

      if (cls == 'example') {
        elemnum = snci.add($(".example")).index(snci);
        snci.prepend('<h2 class="example-header"><span class="cnx_label">Example ' + elemnum + ' </span><strong class="title content-editable" style="display: none;" contenteditable="true"><span class="hint-text">Add a descriptive title (optional)</span></strong></h2>');
        snci.find(".example-contents").contents().wrap('<div class="para content-editable" contenteditable="true"></div>');
        snci.contents().wrapAll('<div class="example-decoration"></div>')
      }
      if (cls == 'exercise') {
        elemnum = snci.add($(".exercise")).index(snci);
        snci.prepend('<h2 class="exercise-header"><span class="cnx_label">Exercise ' + elemnum + ' </span><strong class="title content-editable" style="display: none;" contenteditable="true"><span class="hint-text">Add a descriptive title (optional)</span></strong></h2>');
        snci.find(".exercise-contents").contents().wrap('<div class="problem"><div class="problem-contents"><div class="para content-editable" contenteditable="true"></div></div></div>');
        snci.find(".exercise-contents").append('<div class="add-solution-2" style="display: none"><a href="#asdf">Click to add a solution/answer (optional)</a></div>');
      }
/*
      if (cls == 'question') {
        elemnum = snci.add($(".question")).index(snci);
        snci.prepend('<h2 class="question-header"><span class="cnx_label">Question ' + elemnum + ' </span><strong class="title content-editable" style="display: none;" contenteditable="true"><span class="hint-text">Add a descriptive title (optional)</span></strong></h2>');
        snci.find(".question-contents").contents().wrap('<div class="problem"><div class="problem-contents"><div class="para content-editable" contenteditable="true"></div></div></div>');
        snci.find(".question-contents").append('<div class="add-answer" style="display: none"><a href="#asdf">Click to provide an answer to the question (optional)</a></div>');
      }
*/
      if (cls == 'note') {
        snci.prepend('<h2 class="note-header"><span class="cnx_label">Note: </span></h2>');
        snci.find(".note-contents").addClass("content-editable");
        snci.find(".note-contents").attr("contenteditable","true");
        snci.contents().wrapAll('<div class="note-decoration"></div>')
      }
      if (cls == 'equation') {
        elemnum = snci.add($(".equation")).index(snci);
        snci.append('<span class="equation-number">(' + elemnum + ')</span>');
        snci.find(".equation-contents").addClass("content-editable");
        snci.find(".equation-contents").attr("contenteditable","true");
      }

      addHandles($("#SemanticNew"));
      $("#SemanticNew").removeAttr("id").effect("highlight", { color: "#C5DAE9" }, 1500);
    }
  });


  $("#pedagog ul a").toggle(function(e){
    $(this).addClass("pedagog-click");
  }, function(e){
    $(this).removeClass("pedagog-click");
  });

/*
  $("#canvas .para").each(function(e){
    alert($(this).prev().attr("class"));
  });
*/
  var eqcw = $(".equation").parent();
  $("#canvas .para").add(eqcw)
    .after("<div class='droppable-all droppable-all-existing'/>");
/*
  $("#canvas .para").prev("*:not(.para)")
    .before("<div class='droppable-all'/>")
    .before("<div>asdf</div>");
  $("#canvas .para").each(function(e){
alert($(this).prev().attr("class"));
    if (!$(this).prev().hasClass(".para")) {
      $(this).before("<div class='droppable-all'/>")
//      $(this).before("<div>asdf</div>");
    }
  });
*/
  // Trying something slightly different to avoid the problems of sibling paras getting double-contents dropped into them.
  $("#canvas .section-contents, .problem-contents, .solution-contents, .example-contents, .note-contents, .rule-contents, #cnx_main")
    .prepend("<div class='droppable-all droppable-all-existing'/>");

  $(".droppable-all").each(function(){
    var pw = $(this).parent().innerWidth();
    $(this).css("width",pw)
  });

/*
  $(".add-solution-2").click(function(e){
    buildSolution($(this),e);
  });
  $(".add-answer").click(function(e){
    buildSolution($(this),e,"Answer");
  });
*/

  $(".pedagog").each(function(e){
    var elemFormal = $(this).find(".node").clone().children().remove().end().text().trim();
    if (elemFormal == 'Numbered Equation') elemFormal = 'Equation';
    if (elemFormal.indexOf('Exercise') > -1) elemFormal = 'Exercise';
    if (elemFormal.indexOf('Question') > -1) elemFormal = 'Question';
    var elem = elemFormal.toLowerCase();
    elem = "." + elem  + ":visible";
    var elemcount = $(elem).length;
    if (elemcount == 0) {
      $(this).prepend('<div class="count zero">0</div>');
    } else {
      var lis = ''
      $(elem).each(function(index,e){
        ind = index + 1;
        lis += '<li><a href="#' + this.id + '" title="Jump to this ' + elem + '">' + elemFormal + ' ' + ind + '</a></li>';
      });
      $(this).prepend('<div class="count"><a href="#" class="count-total">' + elemcount + '</a><div class="node-list"><strong>' + elemFormal + 's in this document</strong><ul>' + lis + '</ul></div></div>');
    }
  });


  $("#pedagog .count").hover(function(e){
    var arrow = "<span class='count-arrow' style='height: ";
    var height = $(this).outerHeight();
    var arrow = arrow + height + "px\; width: " + height/2 + "px\;'></span>"
    $(this).find(".count-total").append(arrow);
    $(this).parent().removeAttr("title");
//    $(this).attr("title","Click to view a list of these elements already in the document.")
    $(this).find(".count-total").addClass("count-total-hover");
    $(this).find(".node-list").show();
    pedagogLiLeave($(this).closest(".pedagog"),e);
    $("#pedagog li.pedagog").die("mouseenter");
  }, function(e){
    $(".node-list").hide();
    $(this).find(".count-total").removeClass("count-total-hover");
    $(this).find(".count-arrow").remove();
    if (e.relatedTarget.parentNode.className.indexOf("pedagog") > -1) {
      pedagogLiEnter($(this).closest(".pedagog"),e);
    }
    $("#pedagog li.pedagog").live("mouseenter", function(e){
      pedagogLiEnter($(this),e);
    });
  });

  $("#pedagog .count").click(function(e){
    return false;
  });

/*
  $("#pedagog .count-total").click(function(e){
    var nl = $(this).parent().find(".node-list");
    if (nl.css("display") == 'none') {
      nl.show();
    } else {
      nl.hide();
    }
    $(this).parent().removeAttr("title");
    $(this).parent().parent().removeAttr("title");
  });
*/

  $(".node-list a").click(function(e){
/*
    target = $(this).attr("href");
    window.location = target;
*/
    var canvasOT = $("#canvas").offset().top;
    e.preventDefault();
    $('body,html').animate({
        scrollTop:$(this.hash).offset().top - canvasOT,
      }, 500);
    $(this.hash).effect("highlight", { color: "#E5EEF5" }, 1500);
  });

  $(".node").hover(function(e){
//    $(this).find(".plus").css("visibility","visible");
    $(this).find(".plus").css("color","#000");
    $(this).parent().not(".pedagog-glossary").attr("title","Drag this item to the place you want it on the page.");
  }, function(e){
//    $(this).find(".plus").css("visibility","hidden");
    $(this).find(".plus").css("color","#999");
  });

  
  $("#pedagog li.pedagog").live("mouseenter", function(e){
    pedagogLiEnter($(this),e);
  });
  $("#pedagog li.pedagog").live("mouseleave", function(e){
    pedagogLiLeave($(this),e);
  });
  
  function pedagogLiEnter(pl,e) {
    pl.addClass("hovered");
  }
  function pedagogLiLeave(pl,e) {
    pl.removeClass("hovered");
  }

  $(".pedagog-glossary").click(function(e){
    $(this).find("input").attr("checked","checked");
    $("#artboard").scrollTo(".glossary-outer",{duration:700,over:0.5,onAfter:function(){
        $(".glossary-container").show();
        $("#artboard").scrollTo(".glossary-outer",{duration:500});
      }
    });
  });


  $(".canvas-buddy").each(function(e){
    ttl = $(this).children("a").attr("title");
    $(this).attr("title",ttl);
  });

  $(".element-options-tabs li").click(function(e){
     var eoid = $(this).attr("id").replace("-tab","");
     $(this).closest(".element-options").find(".element-options-tabs li").removeClass("selected");
     $(this).addClass("selected");
     $(this).closest(".element-options").find(".element-options-contents").hide();
     $("#" + eoid).show();
     return false;
  });

  $("input[name='custom-label']").focus(function(e){
    $("input[value='custom'][name='label']").attr("checked","checked");
  });
  $("input[name='custom-label2']").focus(function(e){
    $("input[value='custom2'][name='label2']").attr("checked","checked");
  });
  $("input[name='custom-label3']").focus(function(e){
    $("input[value='custom3'][name='label3']").attr("checked","checked");
  });


  $(".MathJax").attr("contentEditable","false");
  $(".canvas-wrap").attr("contentEditable","false");

  var cheatsheet = '\
    <div id="cheat-sheet-wrap">\
      <div id="cheat-sheet-open"><img src="content_files/open-cheat-sheet-01.png"></div>\
      <div id="cheat-sheet">\
        <div id="cheat-sheet-close"><img src="content_files/close-cheat-sheet-01.png"></div>\
        <div id="cheat-sheet-title"><strong>Math Cheat Sheet</strong>: Copy the "code" that matches the display you want. Paste it into the math entry box above. Adjust as needed.</div>\
        <div id="cheat-sheet-type">\
          <div>\
            <input type="radio" name="cs-math-type" id="cs_radio_ascii" value="cs_ascii" checked="checked"> <label for="cs_radio_ascii">ASCIIMath</label>\
          </div>\
          <div>\
            <input type="radio" name="cs-math-type" id="cs_radio_latex" value="cs_latex"> <label for="cs_radio_latex">LaTeX</label>\
          </div>\
        </div>\
        <div id="cheat-sheet-ascii" class="cheat-sheet-values">\
          <table><tbody><tr>\
            <td style="font-family: helvetica"><strong>Display:</strong></td>\
            <td><img src="content_files/root2over2.gif"/></td>\
            <td><img src="content_files/pirsq.gif"/></td>\
            <td><img src="content_files/xltoet0.gif"/></td>\
            <td><img src="content_files/infinity.gif"/></td>\
            <td><img src="content_files/aplusxover2.gif"/></td>\
            <td><img src="content_files/choose.gif"/></td>\
            <td><img src="content_files/integral.gif"/></td>\
            <td><img src="content_files/function-01.gif"/></td>\
            <td><img src="content_files/matrix-01.gif"/></td>\
            <td><img src="content_files/sin-01.gif"/></td>\
            <td><img src="content_files/piecewise-01.gif"/></td>\
            <td><img src="content_files/standard-product-01.gif"/></td>\
          </tr>\
          <tr>\
            <td style="font-family: helvetica"><strong>ASCIIMath code:</strong></td>\
            <td>sqrt(2)/2</td>\
            <td>pir^2  or  pi r^2</td>\
            <td>x &lt;= 0</td>\
            <td>x -&gt; oo</td>\
            <td>((A+X)/2 , (B+Y)/2)</td>\
            <td>sum_{k=0}^{s-1} ((n),(k))</td>\
            <td>int_-2^2 4-x^2dx</td>\
            <td>d/dxf(x)=lim_(h->0)(f(x+h)-f(x))/h</td>\
            <td>[[a,b],[c,d]]((n),(k))</td>\
            <td>sin^-1(x)</td>\
            <td>x/x={(1,if x!=0),(text{undefined},if x=0):}</td>\
            <td>((a*b))/c</td>\
          </tr></tbody></table>\
        </div>\
        <div id="cheat-sheet-latex" style="display: none;" class="cheat-sheet-values">\
          Fill in later\
          <br/>\
          <br/>\
          <br/>\
          <br/>\
          <br/>\
          <br/>\
        </div>\
        <div style="clear: both"></div>\
      </div>\
    </div>\
  ';
  $("#artboard-inner").append(cheatsheet);
  $("#cheat-sheet-wrap, #toolbar").css("width",$('#artboard-inner').outerWidth() + "px");

/*
  $('.canvas-wrap').on("mousestop", 200, function(e) {
    cwEnter($(this),e);
  });
*/

});

  $(".clear-text-from-input").live("click", function(e){
    $(this).parent().find("input").val('')
    return false;
  });


  $(".menu-list li:not('.menu-list.disabled li')").live("mouseenter", function(e){
    $(this).addClass("hovered");
  });
  $(".menu-list li").live("mouseleave", function(e){
    $(this).removeClass("hovered");
  });

  function tableEditorRemove(e) {
    $("td,th").removeClass("current-cell"); // Really inefficient, I'm sure.
    $("#table-flyout").remove();
    $("#toolbar-table").removeClass("selected");
    var exText = $("#TableNew").text().trim();
    if (exText == '') {
      $("#TableNew").remove();
    } else {
      $("#TableNew").replaceWith(exText);
    }
  }

  function mathIconEnter(mi,e){
    mi.addClass("hovered");
    mi.closest(".MathJax").removeAttr("title");
  }
  function mathIconLeave(mi,e){
    mi.removeClass("hovered");
    mi.closest(".MathJax").attr("title","Click anywhere on the math to edit it");
  }
  $(".math-icon").live("mouseenter", function(e){
    mathIconEnter($(this),e);
  });
  $(".math-icon").live("mouseleave", function(e){
    mathIconLeave($(this),e);
  });

  function mathEnter(m,e) {
    $('.canvas-wrap').each(function(){
      $(this).children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
      $(this).children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
      $(this).children('.canvas').removeClass("canvas-hovered");
    });
    m.addClass("hovered");
    if(!m.find(".math-editor").length) {
      m.attr("title","Click anywhere on the math to edit it");
//      m.append('<span class="math-icon" id="math-icon-edit"><span class="math-icon-message">Click anywhere on the math to edit it</span></span>');
//      m.append('<div class="math-icon" id="math-icon-clear"><span class="math-icon-message"><span class="math-icon-message-close">X</span> Remove math formatting (revert to plain text)</span></div>');
      mic = '<div class="math-icon" id="math-icon-clear"><span class="math-icon-message"><span class="math-icon-message-close">X</span> Remove math formatting (revert to plain text)</span></div>';
      m.append(mic);
//      $(".math-icon").show(1000);
      setTimeout(function(){$(".math-icon").show();}, 600);
    }
    e.stopPropagation();
  }

  function mathLeave(m,e) {
/*
    if(!m.find(".math-editor").length) {
      m.removeClass("selected");
    }
*/
    m.removeClass("hovered");
    m.removeAttr("title");
    m.find('#math-icon-edit').remove();
    m.find('#math-icon-clear').remove();
    if ( !m.parents().closest(".active").length) {
      m.parent().closest('.canvas-wrap').each(function(){
        $(this).children().children().children('.canvas-buddy, .canvas-buddy-2').show();
        $(this).children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').show();
        $(this).children('.canvas').addClass("canvas-hovered");
      });
    }
  }
  function buildMathEditor(m,e) {
    var ed = '<div class="math-editor" contenteditable="false">\
        <span id="math-editor-help" class="math-editor-help">\
          <a href="#asdfasdfasdf" title="Open a pane with information on how to use the math editor">See help</a>\
        </span>\
        <div class="math-source-wrap">\
          <div class="math-source" contenteditable="true"></div>\
          <div id="math-error" contentEditable="false">\
            <strong>LaTeX error:</strong> <br/>Please check your syntax and try again.\
          </div>\
        </div>\
        <div class="math-options">\
          This is:\
          <input type="radio" name="math-type" id="radio_ascii" value="ascii" checked="checked"> <label for="radio_ascii">ASCIIMath</label>\
          <input type="radio" name="math-type" id="radio_latex" value="latex"> <label for="radio_latex">LaTeX</label>\
          <span id="math-type-help" class="math-help"><a href="#asdfasdf" title="Open a pane with information on ASCIIMath and LaTeX">(?)</a></span>\
          <span id="cheat-sheet-activate">\
            <input type="checkbox" name="cheat-sheet-activator" id="cheat-sheet-activator">\
            <label for="cheat-sheet-activator">Show cheat sheet</label>\
          </span>\
        </div>\
        <div id="math-done">\
          <input class="math-done" type="button" value="Done"/>\
        </div>\
        <div class="math-help-text-wrap">\
          <div class="math-help-text" id="math-type">\
            <span class="math-help-text-close">x</span>\
            ASCIIMath and LaTeX transform plain text into mathematics format.\
            <ul>\
              <li>\
                <strong>ASCIIMath</strong> is a simple input notation similar to that of a graphing calculator.\
                For example, <span style="font-family: courier new">x^(ab)</span> would display as \
                <span class="math-style">x<sup style="line-height: .5em; vertical-align: .3em;">ab</sup></span>.\
                <a href="http\:\/\/www1.chapman.edu\/\~jipsen\/asciimath.html" target="_blank" title="Opens in a new window/tab" class="external">Learn more.</a>\
              </li>\
              <li>\
                <strong>LaTeX</strong>, while similar to ASCIIMath, includes some more complex notation for advanced math.\
                <a href="http\:\/\/en.wikibooks.org/wiki/LaTeX/Mathematics" target="_blank" title="Opens in a new window/tab" class="external">Learn more.</a>\
              </li>\
            </ul>\
            Click the "<strong>Show cheat sheet</strong>" box to see examples of each.\
          </div>\
          <div class="math-help-text" id="math-editor-help-text">\
            <span class="math-help-text-close">x</span>\
            To add math to your document, type math in the text field using either \
            <a href="#asd" id="math-type-help-2">ASCIIMath or LaTeX notation</a>.\
            The display math will be shown below in real time.  When you\'re done, just click anywhere outside the blue box.\
            <ul>\
              <li>\
                <strong>Show cheat sheet</strong>.  Use this to see common examples of notation and their respective display.\
              </li>\
              <li>\
                <strong>Show advanced options</strong>.  Use this to switch between your choice of ASCIIMath or LaTeX.\
              </li>\
            </ul>\
          </div>\
        </div>\
      </div>';
    return ed;
  }
  function mathClick(m,e) {

    $("[class*='-header']").die("mouseenter mouseleave"); // Turning hovers off (temporarily)
    $(".canvas-wrap").die("mouseenter mouseleave"); // Have to do this one separately from above, apparently
    $(".MathJax").die("mouseenter mouseleave");
    $("table caption").die("mouseenter mouseleave");

    cwLeave($(".canvas-wrap"),"special");

    if (m.find(".hint-text").length) {
      m.find(".hint-text").replaceWith("&nbsp\;");
      $(this).data("blank-equation",true);
    } else {
      $(this).data("blank-equation",false);
    }

    if(!m.find(".math-editor").length) {
      mathEditorRemove("");
      m.removeAttr("title");

      $('#math-icon-clear').remove();

      m.addClass("selected");
      $("#toolbar-math").addClass("selected");

      mec = buildMathEditor(m,e);
      m.prepend(mec);
      var mathtext = m.find(".ascii-notation").text();

      $('#math-icon-clear').remove();

      if (mathtext.length) {
        m.find(".math-source").append(mathtext);
      } else if ( m.find(".MathJaxText, .MathJaxText2").text().length ) {
        m.find(".math-source").append(m.find(".MathJaxText, .MathJaxText2").text());
      } else if ($(this).data("blank-equation") == true) {
        m.find(".math-source").append('<span class="math-source-hint-text">Enter your math notation here</span>');
      } else {
        m.find(".math-source").append("&nbsp\;");
      }

      $('#math-icon-clear').remove();

      newB = m.outerHeight() + 14; // 14 = approx. positive value of :after's "bottom" property
      newL = m.outerWidth() / 2 - parseInt($(".math-editor").css("width")) / 2 - 7; // 7 for mysterious good measure
      $(".math-editor").css("bottom", newB + "px");
      $(".math-editor").css("left", newL + "px");
      $(".math-source").css("width", $(".math-editor").outerWidth() - $("#math-editor-help").outerWidth() - 2 - 20 - 10  + "px");

      if ($(this).data("blank-equation") != true) {
        placeCaretAtEnd($(".math-source").get(0));
      }

      $('#math-icon-clear').remove();

    } else {
      placeCaretAtEnd($(".math-source").get(0));
    }
    if ( $("#cheat-sheet").css("display") != 'none' ) $("#cheat-sheet-activator").attr("checked",true);
    $("#cheat-sheet-wrap").slideUp("fast", function(e){
      $(this).show();
    });
    e.stopPropagation();
  }

  $(".math-source").live("click", function(e){
    $(this).find(".math-source-hint-text").replaceWith("&nbsp;");
  });

  $(".math-source").live("keyup", function(e){
    AMdisplay($(this),$(this).closest(".MathJax").find(".ascii-math"),true);
//    $(this).closest(".MathJax").find(".ascii-math").html($(this).text());
  });

/*
  $(".math-source").live("paste", function(e){
  });
*/

  var aol = '';

  function mathClickNew(aol,e) {
    var exText = getSelectionText();
    if (exText == '') {
      exText = '&nbsp\;';
//      pasteHtmlAtCaret('<span id="MathJaxNew" class="MathJax selected" contenteditable="false">' + exText + '</span>');
      pasteHtmlAtCaret('<span id="MathJaxNew" class="MathJax selected" contenteditable="false"><span class="ascii-notation" style="display: none;">' + exText + '</span><span class="ascii-math"></span></span>');

      $("[class*='-header']").die("mouseenter mouseleave"); // Turning hovers off (temporarily)
      $(".canvas-wrap").die("mouseenter mouseleave"); // Have to do this one separately from above, apparently
      $(".MathJax").die("mouseenter mouseleave");
      $("table caption").die("mouseenter mouseleave");
      cwLeave($(".canvas-wrap"),"special");
      $("#toolbar-math").addClass("selected");

      mec = buildMathEditor();
      
      var m = $("#MathJaxNew")
      m.prepend(mec)
      newB = m.outerHeight() + 15 + 14; // 14 = approx. positive value of :after's "bottom" property
      newL = m.outerWidth() / 2 - parseInt($(".math-editor").css("width")) / 2 - 7; // 7 for mysterious good measure
      $(".math-editor").css("bottom", newB + "px");
      $(".math-editor").css("left", newL + "px");
      // Not sure following condition is necessary ... might be copy/paste issue only
      if (exText == '&nbsp;') {
        m.find(".math-source").append('<span class="math-source-hint-text">Enter your math notation here</span>');
      } else {
        m.find(".math-source").append(exText);
        placeCaretAtEnd($(".math-source").get(0));
      }
      if ( $("#cheat-sheet").css("display") != 'none' ) $("#cheat-sheet-activator").attr("checked",true);
      $("#cheat-sheet-wrap").slideUp("fast", function(){
        $(this).show();
      });

    } else {
//      pasteHtmlAtCaret('<span id="MathJaxNew" class="MathJax" contenteditable="false"><span class="MathJaxText">' + exText + '</span></span>');
      pasteHtmlAtCaret('<span id="MathJaxNew" class="MathJax" contenteditable="false"><span class="ascii-notation" style="display: none;">' + exText + '</span><span class="ascii-math"></span></span>');
/*
      var mis = '';
      for (var i=0; i < exText.length; i++) {
        mis += '<mi>' + exText.charAt(i) + '</mi>';
      }
      $("#MathJaxNew").find(".ascii-math").append('<math><mstyle displaystyle="true" fontfamily="serif">' + mis + '</mstyle></math>');
*/
      var mathml = AMparseMath2(exText);
      $("#MathJaxNew").find(".ascii-math").append(mathml);
      $("#toolbar-math").removeClass("selected");
      $("#MathJaxNew").removeAttr("id").effect("highlight", { color: "#C5DAE9" }, 1500);
    }

    e.stopPropagation();
    e.preventDefault();

  }

  function pasteHtmlAtCaret(html) { // From Tim Down at http://stackoverflow.com/questions/6690752/insert-html-at-cursor-in-a-contenteditable-div
    var sel, range;
    if (window.getSelection) {
        // IE9 and non-IE
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();

            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = document.createElement("div");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);

            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (document.selection && document.selection.type != "Control") {
        // IE < 9
        document.selection.createRange().pasteHTML(html);
    }
  }


  function mathEditorRemove(override) {
//    if (!$("#MathJaxNew").length || override.length) { // Hack because propagation doesn't seem to be stopping in mathClickNew2

      $(".MathJax").removeClass("selected");
      $(".MathJax").removeClass("hovered");
      if ($("#cheat-sheet-wrap").css("display") != 'none') {
        $("#cheat-sheet-wrap").slideDown("fast", function(e){
          $(this).hide();
        });
      }
      var mj = $(".math-editor").closest(".MathJax");
      var ms = $(".math-editor").find(".math-source").text();
      
      if ((override.length || $("#radio_regular").is(":checked")) && !$(".math-source-hint-text").length) {
        if (ms == "&nbsp\;") {
          mj.replaceWith("");
        } else {
          mj.replaceWith(ms);
        }
      } else {
        if (!mj.find(".ascii-notation").length) { // This just not to mess up the nice examples in the mock-up.
//        if (!ms.trim().length || $("#MathJaxNew").find(".math-source-hint-text").length) {
          if (!ms.trim().length || mj.find(".math-source-hint-text").length) {
            if (mj.parent(".equation-contents").length || mj.parent().parent(".equation-contents").length) {
              mj.html('<div class="hint-text">Enter your math notation here</div>');
            } else {
              mj.remove();
            }
          } else {
            mj.html('<span class="MathJaxText">' + ms + '</span>');
          }
        }
      }
      $(".math-editor").remove();
      $("#toolbar-math").removeClass("selected");
      $(".MathJax").each(function(){
        if ($(this).attr("id") == 'MathJaxNew') {
          $(this).removeAttr("id");
        }
      });
    }
//  }
  $(".MathJax").live("mouseenter", function(e){
    mathEnter($(this),e);
  });
  $(".MathJax").live("mouseleave", function(e){
    mathLeave($(this),e);
  });
  $(".MathJax:not(.selected)").live("click", function(e){
    mathClick($(this),e);
  });
  $(".math-editor").live("click", function(e){
//  e.stopPropagation();
    meClick($(this),e);
  });
  function meClick(me,e) {
    e.stopPropagation();
  };
  
  $("#cheat-sheet-wrap, .MathJax.selected").live("click", function(e){
    meClick($(this),e);
  });

  $("#cheat-sheet-close").live("click", function(e){
    $("#cheat-sheet").slideUp("fast", function(){
      $(this).hide();
    });
    $("#cheat-sheet-open").show("slow");
    $("#cheat-sheet-activator").attr("checked",false);
  });
  $("#cheat-sheet-open").live("click", function(e){
    $(this).hide();
    $("#cheat-sheet").slideDown("fast", function(){
      $(this).show();
    });
    $("#cheat-sheet-activator").attr("checked",true);
  });

  $("#cheat-sheet-activator").live("click", function(e){
    if ($(this).is(":checked")) {
      $("#cheat-sheet-open").hide();
      $("#cheat-sheet").slideDown("fast");
    } else {
      $("#cheat-sheet").slideUp("fast");
      $("#cheat-sheet-open").show("slow");
    }
  });

/*
  $("#math-advanced-activator").live("click", function(e){
    if ($(this).is(":checked")) {
      $("#math-advanced").slideDown("fast");
    } else {
      $("#math-advanced").slideUp("fast");
    }
  });
*/

  $("#radio_regular").live("click", function(e){
    if ($(this).is(":checked")) {
      $(this).closest(".MathJax").find(".MathJaxText").removeClass("MathJaxText").addClass("MathJaxText2");
    } else {
      $(this).closest(".MathJax").find(".MathJaxText2").removeClass("MathJaxText2").addClass("MathJaxText");
    }
  });


  $("#math-icon-clear").live("click", function(e){
      var mj = $(this).closest(".MathJax");
//      var ms = mj.contents(":not(.math-icon)").text();
      var ms = '&nbsp\;';
      if (mj.find(".ascii-notation").text().length) {
        ms = mj.find(".ascii-notation").text();
      } else if ( mj.find(".MathJaxText, .MathJaxText2").text().length ) {
        ms = mj.find(".MathJaxText, .MathJaxText2").text();
      }
      mj.replaceWith(ms);
      return false;
  });

  $("input[name=math-type]").live("click", function(e){
    var m = $(this).closest(".MathJax");
    if ($(this).val() == 'latex') {
      m.addClass("errored");
      m.find(".ascii-math").hide();
      m.find(".ascii-notation").show();
      $("#math-error").css("width",m.find(".math-source").outerWidth() - 28 + "px"); // 28 = 24 total padding + 2 total border + 2 to appear inset
      $("#math-error").slideDown(100, function(e){
        $(this).show();
      });
    } else {
      m.removeClass("errored");
      m.find(".ascii-math").show();
      m.find(".ascii-notation").hide();
      $("#math-error").slideUp(100, function(e){
        $(this).hide();
      });
    }
  });

  $("input[name=cs-math-type]").live("click", function(e){
    var cs = $(this).closest("#cheat-sheet");
    if ($(this).val() == 'cs_latex') {
      cs.find("#cheat-sheet-ascii").hide();
      cs.find("#cheat-sheet-latex").show();
    } else {
      cs.find("#cheat-sheet-ascii").show();
      cs.find("#cheat-sheet-latex").hide();
    }
  });

  $(".image-options-insert.disabled").live("click", function(e){
    if (!$("input[name='img-perms']:checked").val()) {
      $("#img-perms-required").addClass("warning");
    }
    if ($("#drag-image").css("background-image") == 'none') {
//      $("#select-image-required").addClass("warning");
      $("#drag-image").addClass("warning3");
    }
  });

  $("input[name=img-perms]").live("click", function(e){

    $("#img-perms-required").removeClass("warning");

    if ($("#drag-image").css("background-image") != 'none') {
      $(".image-options-insert").removeClass("disabled");

      if (this.id == 'ip-reuse') {
        $("#image-options").data("ip","reuse");
        $(".image-options-insert").text("Next");
      } else {
        $("#image-options").data("ip","other");
//        $(".image-options-insert").text("Insert");
        $(".image-options-insert").text("Next");
      }

    }

  });

  $("html, .math-editor-close, .math-done").live("click", function(e){
/*
    if ($(this).hasClass("math-editor-close")) {
      mathEditorRemove("override");
    } else {
*/
      mathEditorRemove("");
      $(".link, .cnxn").find(".link-options").remove();
      removeLabelList();
/*
    }
*/
    tableEditorRemove(e);
    // Turn hovers back on ...
    $(".canvas-wrap").live("mouseenter", function(e){
      cwEnter($(this),e)
    });
    $(".canvas-wrap").live("mouseleave", function(e){
      cwLeave($(this),e)
    });
    $("[class*='-header']").live("mouseenter", function(e){
      headerEnter($(this),e);
    });
    $("[class*='-header']").live("mouseleave", function(e){
      headerLeave($(this),e);
    });
    $(".MathJax").live("mouseenter", function(e){
      mathEnter($(this),e);
    });
    $(".MathJax").live("mouseleave", function(e){
      mathLeave($(this),e);
    });
/*
    $("table caption").live("mouseenter", function(e){
      headerEnter($(this),e);
    });
    $("table caption").live("mouseleave", function(e){
      tableHeaderLeave($(this),tableTitleHintText,tableCaptionHintText,e);
    });
*/

//    $(".media-block").removeClass("selected");

  });

  function placeCaretAtEnd(el) { // From Tim Down at http://stackoverflow.com/questions/4233265/contenteditable-set-caret-at-the-end-of-the-text-cross-browser
    el.focus();
    if (typeof window.getSelection != "undefined"
            && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    } else if (typeof document.body.createTextRange != "undefined") {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(false);
        textRange.select();
    }
  }

  function selectIcon(fn,aol,e) {
    fn.addClass("selected");
    if (fn.attr("id") == "toolbar-table") {
      var exText = newTablePlaceHolder(e);
      fn.append(tableflyout);
      // If the cursor is in a table, enable the add/delete rows/columns options
      if ( $("#TableNew").closest(".table").length ) {
        $(".menu-list").removeClass("disabled");
        $("#table-flyout-new").addClass("disabled");
        $("#TableNew").closest("td,th").addClass("current-cell");
      }
      $("#table-flyout").data("exText", exText);
    } else if (fn.attr("id") == "toolbar-math") {
      mathClickNew(aol,e);
    } else if (fn.attr("id") == "toolbar-image") {
      var imgPH = newImagePlaceHolder(e);
      $("#image-options").data('div',$("#ImageNew")).data('e',e).dialog("open");
    } else if (fn.attr("id") == "toolbar-link") {
      newLinkPlaceHolder(e);
/*
      var linkPH = newLinkPlaceHolder(e);
      $("#link-options").data('e',e).dialog("open");
*/
    }
    return false;
  }
  function unSelectIcon(fn,e) {
    fn.removeClass("selected");
    if (fn.attr("id") == "toolbar-table") {
      tableEditorRemove();
    } else if (fn.attr("id") == "toolbar-math") {
      mathEditorRemove("");
    }
    return false;
  }

  function newTablePlaceHolder(e) {
    var exText = getSelectionText();
//    if (exText == '') exText = "&nbsp\;";
//    if (exText == "&nbsp\;") {
    if (exText == "&nbsp\;" || exText == '') {
      pasteHtmlAtCaret('<span id="TableNew" class="table-temp-empty">' + exText + '</span>');
    } else {
       pasteHtmlAtCaret('<span id="TableNew" class="table-temp-text">' + exText + '</span>');
    }
    return exText;
    e.stopPropagation();
  }

  function newImagePlaceHolder(e) {
    var imgPH = getSelectionText();
    pasteHtmlAtCaret('<span id="ImageNew" class="image-temp">' + imgPH + '</span>');
    return imgPH;
    e.stopPropagation();
  }

  function newLinkPlaceHolder(e) {
    var linkPHtext = getSelectionText();
    var linkPHparent = $(getSelectionContainerElement());
    if (linkPHparent.closest(".link").length || linkPHparent.closest(".cnxn").length) {
      // If already on a link, edit the whole thing (identified by .LinkNew class, which will be removed after the dialog has closed)
      linkPHparent.addClass("LinkNew");
    } else {
      pasteHtmlAtCaret('<span id="LinkNew" class="image-temp-empty">' + linkPHtext + '</span>');
      // If not already on a link, surround the selected text (or non-text) with a #LinkNew (this ID will be removed after the dialog has closed)
    }
    var linkPH = $(".LinkNew, #LinkNew");
    $("#link-options").data("link",linkPH).data('e',e).dialog("open");
    e.stopPropagation();
  }

  var tableflyout = '\
    <div class="icon-flyout" id="table-flyout">\
      <ul class="menu-list" id="table-flyout-new">\
        <li>\
          <span class="list-text">Add new table</span>\
          <div id="table-flyout-flyout">\
            <div class="flyout-options">\
              <input type="checkbox" id="include-row-header" checked="checked"> <label for="include-row-header">Include header row</label>\
            </div>\
            <div class="flyout-core">\
              <table>\
                <tbody>\
                  <tr>\
                    <td class="header">&nbsp\;</td>\
                    <td class="header">&nbsp\;</td>\
                    <td class="header">&nbsp\;</td>\
                    <td class="header">&nbsp\;</td>\
                    <td class="header">&nbsp\;</td>\
                    <td class="header">&nbsp\;</td>\
                  </tr>\
                  <tr>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                  </tr>\
                  <tr>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                  </tr>\
                  <tr>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                  </tr>\
                  <tr>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                  </tr>\
                  <tr>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                    <td>&nbsp\;</td>\
                  </tr>\
                </tbody>\
              </table>\
            </div>\
            <div id="table-dimensions"/>\
          </div>\
        </li>\
      </ul>\
      <ul class="menu-list disabled" id="table-flyout-insert">\
        <li id="table-add-row-before">Add new row before</li>\
        <li id="table-add-row-after">Add new row after</li>\
        <li id="table-add-column-before">Add new column before</li>\
        <li id="table-add-column-after">Add new column after</li>\
      </ul>\
      <ul class="menu-list disabled" id="table-flyout-delete">\
        <li id="table-delete-row">Delete row</li>\
        <li id="table-delete-column">Delete column</li>\
      </ul>\
      <ul class="menu-list disabled" id="table-flyout-options">\
        <li id="table-options-activate">Table options ...</li>\
      </ul>\
    </div>\
  ';

  function showTableNew(ul,e){
    $("#table-flyout-flyout").show();
    ul.children("li").addClass("hovered");
  }
  function hideTableNew(ul,e){
    $("#table-flyout-flyout").hide();
    ul.children("li").removeClass("hovered");
  }
/*
  $("#table-flyout-new li").hoverIntent({
    over: function(e){
      showTableNew($(this),e);
    }, 
    out: function(e){
      hideTableNew($(this),e);
    },
    interval: 300,
    timeout: 300,
  });
*/
  $("#table-flyout-new:not('.disabled') li").livequery(function(){ // Using livequery since hoverIntent won't work on newly-existing objects :-( but thanks Brandon Aaron for making it :-)
    $(this).hoverIntent({
      over: function(e){
        showTableNew($(this),e);
      }, 
      out: function(e){
        hideTableNew($(this),e);
      },
      interval: 150,
      timeout: 1000,
    });
  });


  $("#table-add-row-before:not('ul.disabled li')").live("mouseenter", function(e){
    $("#TableNew").closest("tr").addClass("add-row-before");
  });
  $("#table-add-row-before:not('ul.disabled li')").live("mouseleave", function(e){
    $("#TableNew").closest("tr").removeClass("add-row-before");
  });
  $("#table-add-row-after:not('ul.disabled li')").live("mouseenter", function(e){
    $("#TableNew").closest("tr").addClass("add-row-after");
  });
  $("#table-add-row-after:not('ul.disabled li')").live("mouseleave", function(e){
    $("#TableNew").closest("tr").removeClass("add-row-after");
  });
  $("#table-add-column-before:not('ul.disabled li')").live("mouseenter", function(e){
    var colI = $("#TableNew").closest("td,th").index() + 1;
    $("#TableNew").closest("table").find("tr").find("td:nth-child(" + colI + "),th:nth-child(" + colI + ")").addClass("add-column-before");
  });
  $("#table-add-column-before:not('ul.disabled li')").live("mouseleave", function(e){
    $("#TableNew").closest("table").find("td,th").removeClass("add-column-before");
  });
  $("#table-add-column-after:not('ul.disabled li')").live("mouseenter", function(e){
    var colI = $("#TableNew").closest("td,th").index() + 1;
    $("#TableNew").closest("table").find("tr").find("td:nth-child(" + colI + "),th:nth-child(" + colI + ")").addClass("add-column-after");
  });
  $("#table-add-column-after:not('ul.disabled li')").live("mouseleave", function(e){
    $("#TableNew").closest("table").find("td,th").removeClass("add-column-after");
  });
  $("#table-delete-row:not('ul.disabled li')").live("mouseenter",function(e){
    $("#TableNew").closest("tr").addClass("table-to-remove");
  });
  $("#table-delete-row:not('ul.disabled li')").live("mouseleave",function(e){
    $("#TableNew").closest("tr").removeClass("table-to-remove");
  });
  $("#table-delete-column:not('ul.disabled li')").live("mouseenter",function(e){
    var colI = $("#TableNew").closest("td,th").index() + 1;
    $("#TableNew").closest("table").find("tr").find("td:nth-child(" + colI + "),th:nth-child(" + colI + ")").addClass("table-to-remove");
  });
  $("#table-delete-column:not('ul.disabled li')").live("mouseleave",function(e){
    $("#TableNew").closest("table").find("td,th").removeClass("table-to-remove");
  });
  $("#table-options-activate:not('ul.disabled li')").live("click",function(e){
    tableOptions($(".current-cell").closest(".canvas"));
    unSelectIcon($("#toolbar-table"),e)
  });


  function cwEnter(cw,e) {

      $('.canvas-wrap').each(function(){
        $(this).children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
        $(this).children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
        $(this).children('.canvas').removeClass("canvas-hovered");
      });
      cw.children('.canvas').addClass("canvas-hovered");
      cw.children().children().children('.canvas-buddy, .canvas-buddy-2').show();
      cw.children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').show();
      if (cw.children('.exercise').length) {
        cw.children('.exercise').find(".add-solution-2").slideDown("fast");
      }
      if (cw.children('.question').length) {
        cw.children('.question').find(".add-answer").slideDown("fast");
      }
      if (cw.children('.table').length) {
        headerEnter(cw.children('.table').find("caption"),e);
      }
      if (cw.children('.solution').length) {
        if (cw.closest('.exercise').find('.add-solution-2').is(':hidden')) {
          cw.closest('.exercise').find(".add-solution-2").slideDown("fast");
        }
      }
      if (cw.children('.answer').length) {
        if (cw.closest('.question').find('.add-answer').is(':hidden')) {
          cw.closest('.question').find(".add-answer").slideDown("fast");
        }
      }
      e.stopPropagation();
  }

  function cwLeave(cw,special) {

      cw.children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
      cw.children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').hide();
      cw.children('.canvas').removeClass("canvas-hovered");
      if (cw.children('.exercise').length) {
        cw.children('.exercise').find(".add-solution-2").slideUp("fast");
      }
      if (cw.children('.question').length) {
        cw.children('.question').find(".add-answer").slideUp("fast");
      }
//alert (e.relatedTarget.parentNode.className);

      if (cw.children('.figure').length) {
        cw.children('.figure').find('.media-title').removeClass("hovered");
        cw.children('.figure').find('.media-title-close').hide();
        cw.children('.figure').find('.media-caption').removeClass("hovered");
        cw.children('.figure').find('.media-caption-close').hide();
      }
      if (cw.children('.table').length) {
        tableHeaderLeave(cw.children('.table').find("caption"),tableTitleHintText,tableCaptionHintText);
      }
      if ( !cw.parents().closest(".active").length && special != "special") {
        cw.parent().closest('.canvas-wrap').each(function(){
          $(this).children().children().children('.canvas-buddy, .canvas-buddy-2').show();
          $(this).children().children().children().children().children('.canvas-buddy, .canvas-buddy-2').show();
          $(this).children('.canvas').addClass("canvas-hovered");
        });
      }
  }

  $(".canvas-wrap").live("mouseenter", function(e){
    cwEnter($(this),e);
  });
  $(".canvas-wrap").live("mouseleave", function(e){
    cwLeave($(this),e);
  });



  function getSelectionText() { // from Tim Down at http://stackoverflow.com/questions/5379120/jquery-get-the-highlighted-text
    var text = "";
    if (window.getSelection) {
        text = window.getSelection().toString();
    } else if (document.selection && document.selection.type != "Control") {
        text = document.selection.createRange().text;
    }
    return text;
  }

  function getSelectionContainerElement() { // From Tim Down at http://stackoverflow.com/questions/1563427/how-do-i-find-out-the-dom-node-at-cursor-in-a-browsers-editable-content-window/1563492#1563492
    var range, sel, container;
    if (document.selection && document.selection.createRange) {
        // IE case
        range = document.selection.createRange();
        return range.parentElement();
    } else if (window.getSelection) {
        sel = window.getSelection();
        if (sel.getRangeAt) {
            if (sel.rangeCount > 0) {
                range = sel.getRangeAt(0);
            }
        } else {
            // Old WebKit selection object has no getRangeAt, so
            // create a range from other selection properties
            range = document.createRange();
            range.setStart(sel.anchorNode, sel.anchorOffset);
            range.setEnd(sel.focusNode, sel.focusOffset);

            // Handle the case when the selection was selected backwards (from the end to the start in the document)
            if (range.collapsed !== sel.isCollapsed) {
                range.setStart(sel.focusNode, sel.focusOffset);
                range.setEnd(sel.anchorNode, sel.anchorOffset);
            }
        }

        if (range) {
           container = range.commonAncestorContainer;

           // Check if the container is a text node and return its parent if so
           return container.nodeType === 3 ? container.parentNode : container;
        }   
    }
  }

  var desctitle = '<span class="hint-text">Add a descriptive title (optional)</span>';

  function headerEnter(h,e) {
    h.find(".title").show();
    h.find(".table-caption").show(); // Might not be there for elements other than table
  }
  function headerLeave(h,desctitle,e) {
    var title = h.find(".title");
/*
    var label = h.find(".cnx_label");
    var labelt = label.text().trim();
*/
    if (h.find(".hint-text").length) {
      title.hide();
    } else if (title.text().trim() == '') {
      title.hide();
      title.prepend(desctitle);
      title.blur();
/*
      if (labelt.substr(labelt.length - 1) == ":") {
        label.text(labelt.substring(0, labelt.length - 1));
      }
*/
    }
  }
  function headerClick(h,e) {
    h.find(".title .hint-text").remove();
/*
    // Not sure why I have to have the following in both headerClick and titleFocus. Oh well.
    var label = h.find(".cnx_label").text().trim();
    if (label.substr(label.length - 1) != ":") {
      h.find(".cnx_label").text(label + ": ");
    }
*/
    h.find(".title").focus();
  }
  function titleFocus(t,e) {
    var label = t.parent().find(".cnx_label").text().trim();
    if (label.substr(label.length - 1) != ":") {
      t.parent().find(".cnx_label").text(label + ": ");
    }
  }
  function titleBlur(t,desctitle,e) {
    if (t.text().trim() == '') {
      t.prepend(desctitle);
      t.hide();
    }
  }
  $("[class*='-header']").live("mouseenter", function(e){
    headerEnter($(this),e);
  });
  $("[class*='-header']").live("mouseleave", function(e){
    headerLeave($(this),desctitle,e);
  });
  $("[class*='-header']").live("click", function(e){
    headerClick($(this),e);
  });
/*
  $("strong.title:not(table>caption>.title)").live("focus", function(e){
    titleFocus($(this),e);
  });
*/
  $("strong.title").live("blur", function(e){
    titleBlur($(this),desctitle,e);
  });


  var tableTitleHintText = '<span class="hint-text">&nbsp\;Add a title (optional)</span>';
  var tableCaptionHintText = '<span class="hint-text">&nbsp\;Add a table caption (optional)</span>';
/*
  function tableTitleClick(tt) {
    var label = tt.parent().find(".cnx_label").text().trim();
    tt.children(".hint-text").remove();
    if (label.substr(label.length - 1) != ":") {
      tt.parent().find(".cnx_label").text(label + ": ");
    }
    tt.focus();
  }
*/
  function tableCaptionClick(tc) {
    var label = tc.parent().find(".cnx_label").text().trim();
    tc.find(".hint-text").remove();
    if (label.substr(label.length - 1) != ":") {
      tc.parent().find(".cnx_label").text(label + ": ");
    }
    tc.focus();
  }
  function tableHeaderLeave(h,desctitle,desccaption) {
    var caption = h.find(".table-caption");
    var label = h.find(".cnx_label");
    var labelt = label.text().trim();
    if (caption.find(".hint-text").length) {
      caption.hide();
    }
    if (caption.text().trim() == '') {
      caption.hide();
      caption.prepend(desccaption);
    }
    caption.blur();
    if (caption.find(".hint-text").length && labelt.substr(labelt.length - 1) == ":") {
        label.text(labelt.substring(0, labelt.length - 1));
    }
  }
/*
  $("table caption").live("mouseenter", function(e){
    headerEnter($(this),e);
  });
  $("table caption").live("mouseleave", function(e){
    tableHeaderLeave($(this),tableTitleHintText,tableCaptionHintText,e);
  });
*/
/*
  $("table>caption>.title").live("click", function(e){
    tableTitleClick($(this),e);
  });
*/
  $("table>caption>.table-caption").live("click", function(e){
    tableCaptionClick($(this),e);
  });
/*
  $("table>caption>strong.title").live("blur", function(e){
    titleBlur($(this),tableTitleHintText,e);
  });
*/
  $("table>caption>.table-caption").live("blur", function(e){
    titleBlur($(this),tableCaptionHintText,e);
  });



  function cbEnter(cb) {
    cb.css("background-color","#666");
    cb.parent().css("background-color","#f2f2f2");
    cb.find("img").attr("src","content_files/drag-element-20.png");
    cb.parent().children(".canvas-buddy-2").hide();
//    cb.closest(".canvas").addClass("canvas-hovered");
  }
  function cbLeave(cb) {
    cb.css("background-color","transparent");
    cb.parent().css("background-color","transparent");
    cb.find("img").attr("src","content_files/drag-element-19.png");
    cb.parent().children(".canvas-buddy-2").show();
//    cb.closest(".canvas").removeClass("canvas-hovered");
  }
  $(".canvas-buddy").live("mouseenter", function(){
    cbEnter($(this));
  });
  $(".canvas-buddy").live("mouseleave", function(){
    cbLeave($(this));
  });


  function reEnter(re) {
    re.parent().css("border-left-width","0");
    re.parent().parent().children(".canvas-buddy").hide();
    re.parent().find(".edit-element").hide();
    re.parent().parent().parent().css("background-color","#f9f9f9");
    re.parent().parent().addClass("to-remove");
    re.find("img").attr("src","content_files/remove-element-07.png");
//    re.closest(".canvas").addClass("canvas-hovered");
  }
  function reLeave(re) {
    re.parent().css("border-left-width","1px");
    re.parent().parent().children(".canvas-buddy").show();
    re.parent().find(".edit-element").show();
    re.parent().parent().parent().css("background-color","transparent");
    re.parent().parent().removeClass("to-remove");
    re.find("img").attr("src","content_files/remove-element-06.png");
//    re.closest(".canvas").removeClass("canvas-hovered");
  }
  $(".remove-element").live("mouseenter", function(){
    reEnter($(this));
  });
  $(".remove-element").live("mouseleave", function(){
    reLeave($(this));
  });


  function removeElement(el,e) {
/*
    var c = confirm('Are you sure you want to remove this element?');
    if (c == true) {
      $(this).closest('.canvas-wrap').hide("slow", function(){ $(this).remove(); });
*/
      var sol = false;
      var ans = false;
      var exercont = '';
      var questcont = '';
      if (el.parent().parent().parent(".solution").length) {
        sol = true;
        exercont = el.closest(".exercise-contents");
      }
      if (el.parent().parent().parent(".answer").length) {
        ans = true;
        questcont = el.closest(".question-contents");
      }
      el.closest(".canvas-wrap").slideUp("slow", function(){
        $(this).remove();
        if (sol) {
           exercont.append('<div class="add-solution-2" style="display: block;"><a href="#asdf">Click to add an answer/solution (optional)</a></div>');
           exercont.find(".solution-toggle-show").remove();
        }
/*
        if (ans) { 
           questcont.append('<div class="add-answer" style="display: block;"><a href="#asdf">Click to provide an answer to the question (optional)</a></div>');
           questcont.find(".answer-toggle-show").remove();
        }
*/
      });
/*
    }
*/
    e.stopPropagation();
    e.preventDefault();
  }
  $(".remove-element").live("click", function(e){
    removeElement($(this),e);
  });


  function eeEnter(ee,e) {
    ee.find("img").attr("src","content_files/options-06.png");
    ee.parent().css("background-color","transparent");
    ee.parent().css("border-left-color","#c2c2c2");
    ee.parent().parent().parent().css("background-color","#eee");
  }
  function eeLeave(ee,e) {
    ee.find("img").attr("src","content_files/options-05.png");
    ee.parent().css("background-color","#f7f7f7");
    ee.parent().css("border-left-color","#ddd");
    ee.parent().parent().parent().css("background-color","transparent");
  }
  $(".edit-element").live("mouseenter", function(e){
    eeEnter($(this),e);
  });
  $(".edit-element").live("mouseleave", function(e){
    eeLeave($(this),e);
  });


  function addHandles(cw) {
    var buddies = '\
      <div style="display: none;" class="canvas-buddy-2">\
        <a class="edit-element" href="#" title="Edit options for this element">\
          <img src="content_files/options-05.png">\
        </a>\
        <a class="remove-element" href="#" title="Remove this element">\
          <img src="content_files/remove-element-01.png">\
        </a>\
      </div>\
      <div style="display: none;" class="canvas-buddy">\
        <a class="drag-element" href="#" title="Drag this element to another location">\
          <img src="content_files/drag-element-19.png">\
        </a>\
      </div>\
    ';
    cw.children().children().prepend(buddies);
  }

  function buildSolution(solhint,e,label) {
    if (label) {
      label = label;
    } else {
      label = "Solution";
    }
    var labell = label.toLowerCase();
    var emptysol = '\
      <div class="canvas-wrap">\
        <div class="solution canvas">\
          <div class="canvas-inner">\
            <h2 class="solution-header">\
              <span class="cnx_label">' + label + '</span>\
            </h2>\
            <div class="solution-contents">\
              <div class="para content-editable" contentEditable="true">&nbsp\;</div>\
            </div>\
            <div class="' + labell + '-toggle-hide">\
              <span class="' + labell + '-toggle">[ Hide ' + label + ' ]</span>\
            </div>\
          </div>\
        </div>\
      </div>\
      <div class="' + labell + '-toggle-show" style="display: none;">\
        <span class="' + labell + '-toggle">[ Show ' + label + ' ]</span>\
      </div>\
    ';
    solparent = solhint.parent();
    solhint.replaceWith(emptysol);
    addHandles(solparent.children(".canvas-wrap"));
    solparent.find(".solution-contents .para").focus();
    e.preventDefault();
    e.stopPropagation();
  }
  $(".add-solution-2").live("click", function(e){
    buildSolution($(this),e);
  });
  $(".add-answer").live("click", function(e){
    buildSolution($(this),e,"Answer");
  });

  function removeHint(ce,e){
    ce.find(".hint-text").replaceWith("&nbsp;");
  }
/*
  $(".content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
  $(".content-editable").not("table>caption>.content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
*/
/*
  $(".content-editable").live("click", function(e){
    removeHint($(this),e);
  });
  $(".content-editable").not("table>caption>.content-editable").live("focus", function(e){
    removeHint($(this),e);
  });
*/
/*
  $(".content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
  $(".content-editable-2").live("click", function(e){
    removeHint($(this),e);
  });
*/
  $(".example-contents>.content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
  $(".problem-contents>.content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
  $(".note-contents").live("click focus", function(e){
    removeHint($(this),e);
  });
/*
  $(".equation-contents>.content-editable").live("click focus", function(e){
    removeHint($(this),e);
  });
*/


  function addHintIfEmpty(ce,e) {
    if (ce.parent(".problem-contents").length && ce.text().trim() == '') {
      var ht = '<span class="hint-text">Type the text of your exercise/problem/question here</span>';
      ce.prepend(ht);
    }
  }
  $(".problem-contents>.content-editable").live("blur", function(e){
    addHintIfEmpty($(this),e);
  });


  function exerciseOptions(ex) {
    $("#exercise-options").data('exercise',ex).dialog("open");
    return false;
  }
  function exampleOptions(ex) {
    $("#example-options").data('example',ex).dialog("open");
    return false;
  }
  function equationOptions(eq) {
    $("#equation-options").data('equation',eq).dialog("open");
    return false;
  }
  function solutionOptions(so) {
    $("#solution-options").data('solution',so).dialog("open");
    return false;
  }
  function tableOptions(ta) {
    $("#table-options").data('table',ta).dialog("open");
    return false;
  }
  $(".edit-element").live("click", function(e){
    var exercise = $(this).parent().parent().parent(".exercise");
    var example = $(this).parent().parent().parent(".example");
    var equation = $(this).parent().parent().parent(".equation");
    var solution = $(this).parent().parent().parent(".solution");
    var table = $(this).parent().parent().parent(".table");
    if (exercise.length) {
      exerciseOptions(exercise);
      return false;
      e.stopPropagation();
    } else if (example.length) {
      exampleOptions(example);
      return false;
      e.stopPropagation();
    } else if (equation.length) {
      equationOptions(equation);
      return false;
      e.stopPropagation();
    } else if (solution.length) {
      solutionOptions(solution);
      return false;
      e.stopPropagation();
    } else if (table.length) {
      tableOptions(table);
      return false;
      e.stopPropagation();
    }
    return false;
  });

  $(".media-table-add div").live("click", function(e){
    $("#image-options").data('div',$(this)).data('e',e).dialog("open");
    return false;
  });

  $("#upload-image-link").live("click", function(e){
    $("#upload-image").click();
    $("#upload-url").hide();
    e.preventDefault();
  });

  $("#upload-image").live("change", function(e){
    $("#drag-image").css("background-image","url(content_files/cigarette-factory-200.jpg)");

    if ($("input[name='img-perms']:checked").val()) {

      if ($("input[name='img-perms']:checked").attr("id") == 'ip-reuse') {
        $("#image-options").data("ip","reuse");
        $(".image-options-insert").text("Next");
      } else {
        $("#image-options").data("ip","other");
//        $(".image-options-insert").text("Insert");
        $(".image-options-insert").text("Next");
      }

      $(".image-options-insert").removeClass("disabled");
    }
//    $("#select-image-required").removeClass("warning");
    $("#drag-image").removeClass("warning3");
//    $("#image-size").show();
  });

  $("#upload-url-link").live("click", function(e){
    $("#upload-url").show();
    e.preventDefault();
  });

  $("#upload-url input[type='submit']").live("click", function(e){
    img = $(this).siblings().val();
    $("#drag-image").css("background-image","url(" + img + ")");
//    $("#select-image-required").removeClass("warning");
    $("#drag-image").removeClass("warning3");
    if ($("input[name='img-perms']:checked").val()) {
      $(".image-options-insert").removeClass("disabled");      
    }
//    $("#image-size").show();
    e.preventDefault();
  });


  $("#reuse-footnote-edit").live("click", function(e){
    var rft = $("#reuse-footnote-text");
    if ($(this).is(":checked") == true) {
      rft.attr("contentEditable","true");
      rft.removeClass("disabled");
    } else {
      rft.attr("contentEditable","false");
      rft.addClass("disabled");
    }
  });

  $("#reuse-author").live("keyup", function(e){
    $("#rft-text-1").show();
    $("#rft-author").show().text($(this).val().trim());
    $("#rft-text-2").show();
  });

  $("#reuse-url").live("keyup", function(e){
    $("#rft-url").show().find("a").attr("href",$(this).val().trim());
    $("#rft-text-3").show();
  });

  $("#reuse-license").live("change", function(e){
    if (this.selectedIndex != 0 && this.selectedIndex != this.length-1) {
      $("#rft-text-4").show();
      $("#rft-license").show().text($(this).val());
      $("#rft-text-5").show();
    } else {
      $("#rft-text-4").hide();
      $("#rft-license").hide();
      $("#rft-text-5").hide();
    }
  });



  $("#whats-mathtype-dialog").live("click", function(e){
    var helptext = $("#whats-mathtype-dialog-text");
    if (helptext.css("display") == 'none') {
       helptext.slideDown("fast", function(e){
         helptext.show();
       });
    } else {
       helptext.slideUp("fast", function(e){
         helptext.hide();
       });
    }
    e.preventDefault();
  });

  function mathHelpHideAllFirst(h,e) {
    if ( !$(".math-help-text").not(":hidden").length ) {
          mathHelpOpen(h,e);
    } else {
      $(".math-help-text").not(":hidden").each(function(e){
        $(this).animate({
          left: -250,
          height: 0,
        }, "fast", function(e){
          var hwrap = $(".math-help-text-wrap");
          $(this).css("height","auto");
          $(this).hide();
          if (h.attr("id") != this.id) {
            mathHelpOpen(h,e);
/*
          } else if ( $("input[name=math-type]:checked").val() == 'latex' ) {
            mathHelpOpen($("#math-error"),e);
*/
          }
        });
      });
    }
    e.preventDefault();
  }

  function mathHelpOpen(h,e) {
    var hwrap = $(".math-help-text-wrap");
    h.show();
    var hh = h.outerHeight();
    hwrap.css("height",hh + 17 + "px"); // 17 = padding + border + shadow 
    h.animate({
      left: 0,
      height: hh,
    }, "fast", function(e){
    });
  }

  $(".math-help-text-close").live("click", function(e){
    mathHelpHideAllFirst($(this).parent(),e);
  });
  $("#math-type-help, #math-type-help-2").live("click", function(e){
    mathHelpHideAllFirst($("#math-type"),e);
  });
  $("#math-editor-help").live("click", function(e){
    mathHelpHideAllFirst($("#math-editor-help-text"),e);
  });



  function cthListHelpEnter(ht,e) {
    if (!ht.is(":hidden")) {
/*
      ht.animate({
        left: -250,
        height: 0,
      }, "fast", function(e){
        ht.css("height","auto");
        ht.hide();
      });
*/
    } else {
      var hwrap = ht.parent();
      ht.show();
      var hh = ht.outerHeight();
      hwrap.css("height",hh + 17 + "px"); // 17 = padding + border + shadow 
       ht.animate({
        left: 0,
        height: hh,
      }, "fast", function(e){
      });
    }
    e.preventDefault();
  }
  function cthListHelpToggle(ht,e) {
    if (!ht.is(":hidden")) {
      ht.animate({
        left: -250,
        height: 0,
      }, "fast", function(e){
        ht.css("height","auto");
        ht.hide();
      });
    } else {
      var hwrap = ht.parent();
      ht.show();
      var hh = ht.outerHeight();
      hwrap.css("height",hh + 17 + "px"); // 17 = padding + border + shadow 
       ht.animate({
        left: 0,
        height: hh,
      }, "fast", function(e){
      });
    }
    e.preventDefault();
  }
  $(".cth-list-help-text-close").live("click", function(e){
    cthListHelpToggle($(this).parent(),e);
  });
  $(".cth-list-help a").live("mouseenter", function(e){
    cthListHelpEnter($(this).closest(".cth-list").find(".cth-list-help-text"),e);
  });
  $(".cth-list-help a").live("click", function(e){
    cthListHelpToggle($(this).closest(".cth-list").find(".cth-list-help-text"),e);
  });



$(function() {

  $("#pedagog .node").draggable({
   appendTo: "#artboard",
   containment: "#artboard",
//   refreshPositions: true,
   scroll: true,
//    cursorAt: { top: 35, left: 200 },
//    cursorAt: { top: 40, left: -20 },
//    cursorAt: { right: -10, top: 25 },
    drag: function(){
      $(".droppable-all").not(".droppable-hover").css("height","1px");
    },
    helper: function(){
      var exercisehelper = '\
        <div class="dragged">\
          <div class="exercise">\
            <h2 class="exercise-header">\
              <span class="cnx_label">' + $(this).clone().children().remove().end().text() + ':</span>\
            </h2>\
            <div class="exercise-contents">\
              <div class="problem">\
                <div class="problem-contents">\
                  <div class="para">\
                    <i>Drag me to the desired location on the canvas.</i>\
                  </div>\
                </div>\
              </div>\
            </div>\
          </div>\
        </div>\
        ';
      return exercisehelper;
    },
    mouse: "move",
    revert: "invalid",
    opacity: "0.8",
    start: function(){
      $(".droppable-all").addClass("droppable-active");
      $("body").addClass("dragging");
      $("#pedagog .node").addClass("dragging");
      $("#canvas").addClass("dragging");
      $("#toolbar").addClass("no-drop");
      $(".canvas-wrap").unbind("mouseenter mouseleave");
    },
    stop: function(){
      $(".droppable-all").removeClass("droppable-active");
      $(".droppable-all").css("background-image","none"); // Unsure why this is needed.
      $("body").removeClass("dragging");
      $("#pedagog .node").removeClass("dragging");
      $("#canvas").removeClass("dragging");
      $("#toolbar").removeClass("no-drop");
//      $(".canvas-wrap").bind({
//        mouseenter: function(){
//          cwEnter($(this));
//        },
//        mouseleave: function(){
//          cwLeave($(this));
//        },
//      });
    },
  });

/*
  $(".canvas-wrap").draggable({
    appendTo: "#canvas",
    cursorAt: { top: 35, left: 200 },
    containment: "#canvas",
//    refreshPositions: true,
    handle: ".canvas-buddy",
    scroll: true,
    drag: function(){
      $(".droppable-all-existing").not(".droppable-hover").css("height","1px");
    },
//    mouse: "move",
    revert: "invalid",
    start: function(){
      $(".droppable-all-existing").addClass("droppable-active");
      $("body").addClass("dragging");
//      $("#pedagog .node").addClass("dragging");
      $("#canvas").addClass("dragging");
      $("#toolbar").addClass("no-drop");
      $(".canvas-wrap").die("mouseenter mouseleave");
    },
    stop: function(){
      $(".droppable-all-existing").removeClass("droppable-active");
      $(".droppable-all-existing").css("background-image","none"); // Unsure why this is needed.
      $("body").removeClass("dragging");
//      $("#pedagog .node").removeClass("dragging");
      $("#canvas").removeClass("dragging");
      $("#toolbar").removeClass("no-drop");
      $(".canvas-wrap").live("mouseenter", function(e){
        cwEnter($(this),e)
      });
      $(".canvas-wrap").live("mouseleave", function(e){
        cwLeave($(this),e)
      });
    },
  });
*/

  $(".droppable-all").droppable({
    accept: "#pedagog .node, .canvas-wrap",
    hoverClass: "droppable-hover",
    tolerance: "touch",
    over: function(event,ui){
      $(this).addClass("copy-draggable");
      var helperHeight = '';
      if (ui.draggable.hasClass("canvas-wrap")){
        helperHeight = ui.draggable.outerHeight();
//alert(helperHeight);
      } else {
        helperHeight = $(".dragged").outerHeight();
      }
      $(this).css("height", helperHeight + "px");
/*
      $(this).animate({
        height: helperHeight + "px",
      }, "fast");
*/
      $(".droppable-all").not(this).css("height","1px").removeClass("droppable-hover");
    },
    out: function(event,ui) {
      $("#canvas").removeClass("copy-draggable");
      $(this).css("height","1px");
    },
    drop: function(event,ui) {
      if (ui.draggable.hasClass("canvas-wrap")) {
        $(this).after(ui.draggable);
        ui.draggable.context.effect("highlight", { color: "#E5EEF5" }, 1000);
      } else {
        $("body").find(".dragged").remove();
        var semanticelem = $(ui.draggable).clone().children().remove().end().text();
        var semanticelem2 = '<div>' + semanticelem + '</div>';
        var elemnum = '';
        if (semanticelem.indexOf('Exercise') > -1) {
          elemnum = $(this).add($(".exercise")).index($(this)) + 1;
          semanticelem2 = $('\
            <div class="canvas-wrap">\
              <div class="exercise canvas">\
                <div class="canvas-inner">\
                  <h2 class="exercise-header">\
                    <span class="cnx_label">Exercise ' + elemnum + ' </span>\
                    <strong class="title content-editable" style="display: none" contentEditable="true">\
                      <span class="hint-text">Add a descriptive title (optional)</span>\
                    </strong>\
                  </h2>\
                  <div class="exercise-contents">\
                    <div class="problem">\
                      <div class="problem-contents">\
                        <div class="para content-editable" contentEditable="true">\
                          <span class="hint-text">\
                            Type the text of your exercise/problem/question here\
                          </span>\
                        </div>\
                      </div>\
                    </div>\
                    <div class="add-solution-2" style="display: block;">\
                      <a href="#asdf">Click to add a solution/answer (optional)</a>\
                    </div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          ').hide();
/*
        } else if (semanticelem.indexOf('Question') > -1) {
          elemnum = $(this).add($(".question")).index($(this)) + 1;
          semanticelem2 = $('\
            <div class="canvas-wrap">\
              <div class="question canvas">\
                <div class="canvas-inner">\
                  <h2 class="question-header">\
                    <span class="cnx_label">Question ' + elemnum + ' </span>\
                    <strong class="title content-editable" style="display: none" contentEditable="true">\
                      <span class="hint-text">Add a descriptive title (optional)</span>\
                    </strong>\
                  </h2>\
                  <div class="question-contents">\
                    <div class="problem">\
                      <div class="problem-contents">\
                        <div class="para content-editable" contentEditable="true">\
                          <span class="hint-text">\
                            Type your question text here\
                          </span>\
                        </div>\
                      </div>\
                    </div>\
                    <div class="add-answer" style="display: block;">\
                      <a href="#asdf">Click to provide an answer to the question (optional)</a>\
                    </div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          ').hide();
*/
        } else if (semanticelem == 'Example') {
          elemnum = $(this).add($(".example")).index($(this)) + 1;
          semanticelem2 = $('\
            <div class="canvas-wrap">\
              <div class="example canvas">\
                <div class="canvas-inner">\
                  <div class="example-decoration">\
                  <h2 class="example-header">\
                    <span class="cnx_label">Example ' + elemnum + ' </span>\
                    <strong class="title content-editable" style="display: none" contentEditable="true">\
                      <span class="hint-text">Add a descriptive title (optional)</span>\
                    </strong>\
                  </h2>\
                  <div class="example-contents">\
                    <div class="para content-editable" contentEditable="true">\
                      <span class="hint-text">\
                        Type the text of your example here\
                      </span>\
                    </div>\
                  </div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          ').hide();
        } else if (semanticelem == 'Note') {
          elemnum = $(this).add($(".note")).index($(this)) + 1;
          semanticelem2 = $('\
            <div class="canvas-wrap">\
              <div class="note canvas">\
                <div class="canvas-inner">\
                  <div class="note-decoration">\
                  <h2 class="note-header">\
                    <span class="cnx_label">Note ' + elemnum + ' </span>\
                    <strong class="title content-editable" style="display: none" contentEditable="true">\
                      <span class="hint-text">Add a descriptive title (optional)</span>\
                    </strong>\
                  </h2>\
                  <div class="note-contents">\
                    <div class="para content-editable" contentEditable="true">\
                      <span class="hint-text">\
                        Type the text of your note here\
                      </span>\
                    </div>\
                  </div>\
                  </div>\
                </div>\
              </div>\
            </div>\
          ').hide();
        } else if (semanticelem == 'Numbered Equation') {
          elemnum = $(this).add($(".equation")).index($(this)) + 1;
          semanticelem2 = $('\
            <div class="canvas-wrap">\
              <div class="equation canvas">\
                <div class="canvas-inner">\
                  <div class="equation-contents">\
                    <div class="MathJax" contentEditable="false">\
                      <span class="hint-text">\
                        Enter your math notation here\
                      </span>\
                      <span class="ascii-notation"/>\
                      <span class="ascii-math"/>\
                    </div>\
                    <span class="equation-number">(' + elemnum + ')</span>\
                  </div>\
                </div>\
              </div>\
            </div>\
          ').hide();
        }
        $(this).after(semanticelem2);
        var newelem = $(this).next();
        addHandles(newelem);
        newelem.stop().show("slow");
        newelem.effect("highlight", { color: "#E5EEF5" }, 1000);
      }
      $("#canvas").removeClass("copy-draggable");
    },
  });

  // The droppable for moving around existing elements. Tried to combine w/ the other droppable, but couldn't get .data() to pass through. Using hack based on 2nd class.
/*
  $(".droppable-all-existing").droppable({
    accept: ".canvas-wrap",
    hoverClass: "droppable-hover",
    tolerance: "touch",
    over: function(event,ui){
      $(this).addClass("copy-draggable");
      helperHeight = ui.draggable.outerHeight();
      $(this).animate({
        height: helperHeight + "px",
      }, "fast");
      $(".droppable-all-existing").not(this).css("height","1px").removeClass("droppable-hover");
    },
    out: function(event,ui) {
      $("#canvas").removeClass("copy-draggable");
      $(this).css("height","1px");
    },
    drop: function(event,ui) {
      $(this).after(ui.draggable);
      ui.draggable.effect("highlight", { color: "#E5EEF5" }, 1000);
      $("#canvas").removeClass("copy-draggable");
    },
  });
*/

});

$(function() {


  $("#exercise-options").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
/*
    drag: function(){
      $(".draggable-all").unbind("mouseenter mouseleave");
      $(".draggable-all").unbind("mouseenter mouseleave");
      $(".draggable-all").off("mouseenter mouseleave");
      $(".draggable-all").undelegate("mouseenter mouseleave");
    },
*/
    open: function(){
      $(this).data("exercise").addClass("element-being-edited");
    },
    close: function(){
      $(this).data("exercise").removeClass("element-being-edited");
    },
    buttons: {
      "Save Changes": function() {
        $( this ).dialog( "close" );
      },
      Cancel: function() {
        $( this ).dialog( "close" );
      }
    }
  });

  $("#example-options").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
      $(this).data("example").addClass("element-being-edited");
    },
    close: function(){
      $(this).data("example").removeClass("element-being-edited");
    },
    buttons: {
      "Save Changes": function() {
        $(this).dialog( "close" );
      },
      Cancel: function() {
        $(this).dialog( "close" );
      }
    }
  });

  $("#equation-options").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
      $(this).data("equation").addClass("element-being-edited");
    },
    close: function(){
      $(this).data("equation").removeClass("element-being-edited");
    },
    buttons: {
      "Save Changes": function() {
        $(this).dialog( "close" );
      },
      Cancel: function() {
        $(this).dialog( "close" );
      }
    }
  });
  $("#solution-options").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
      $(this).data("solution").addClass("element-being-edited");
    },
    close: function(){
      $(this).data("solution").removeClass("element-being-edited");
    },
    buttons: {
      "Save Changes": function() {
        $(this).dialog( "close" );
      },
      Cancel: function() {
        $(this).dialog( "close" );
      }
    }
  });
  $("#table-options").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
      $(this).data("table").addClass("element-being-edited");
    },
    close: function(){
      $(this).data("table").removeClass("element-being-edited");
    },
    buttons: {
      "Save Changes": function() {
        $(this).dialog( "close" );
      },
      Cancel: function() {
        $(this).dialog( "close" );
      }
    }
  });

  $("#image-options").dialog({
    width: 700,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
      // Not sure why I'm having to do these here, but these "required" warnings are sometimes getting turned on upon initial opening
      $("#img-perms-required").removeClass("warning");
//      $("#select-image-required").removeClass("warning");
      $("#drag-image").removeClass("warning3");
    },
    close: function(){
    },
    buttons: {
      "Next": {
//        text: 'Insert',
//        class: 'image-options-insert disabled', 
        text: 'Next',
        class: 'image-options-insert', 
        click: function() {
          if ($("#image-options").data("ip") == undefined){
            // Do nothing if they haven't provided the source yet.
            return false;
          } else {
            if ($("#image-options").data("ip") == 'reuse') {
              $(this).dialog( "close" );
              var div = $(this).data("div");
              var e = $(this).data("e");
              var reuseUrl = $("#upload-url input[type='text']").val();
              $("#image-options-step-2").data("div",div).data("e",e).dialog( "open" );
              $("#reuse-url").val(reuseUrl);
              if (reuseUrl != '') $("#rft-url").show().find("a").attr("href",reuseUrl.trim());
            } else { 


        $(this).dialog( "close" );
        var div = $(this).data("div");
        var alt = $("#enter-alt textarea").val().trim();
        var altwarn = '';
        if (alt == '') {
          altwarn = '<img class="alt-warning" src="content_files/warning-01.png" title="This image is missing a description for the visually impaired.  Click to provide one." contentEditable="false"/>';
        }
        var selectedImg = $("#drag-image").css("background-image").trim();
        if (selectedImg.charAt(4) == "'" || selectedImg.charAt(4) == '"') {
          selectedImg = selectedImg.substring(5,selectedImg.length - 2);
        } else {
          selectedImg = selectedImg.substring(4,selectedImg.length - 1); // Chrome doesn't include quotes as part of .css("background-image"), apparently
        }
        selectedImg = '<img src="' + selectedImg + '" class="image content-editable" contenteditable="true" width="200" alt="' + alt + '"/>'; // The width for KEF.
        var imgWrap = '<span class="media-inner content-editable" contentEditable="true">\
          ' + selectedImg + altwarn + '\
          <div class="image-options" contenteditable="false">\
            <span class="image-add-options">\
              <label class="image-options-add">Add:</label>\
              <a href="#asaefafedfas" class="image-options-title">Title</a>\
              &#183;\
              <a href="#asdfaasdfasdfs" class="image-options-caption">Caption</a>\
            </span>\
            <a href="#adsfasasdfas" class="image-options-options">\
              <img src="content_files/options-05.png" style="vertical-align: bottom\;"> \
              More options ...\
            </a>\
          </div>\
        </span>\
        ';
        if (div.attr("id") == "ImageNew") {
          // As a new figure somewhere in the document.
          div.replaceWith('\
          <div class="media-block">\
            <div class="media-title">\
              <span class="media-title-close">X</span>\
              <div class="hint-text">Add a title for this image (optional)</div>\
            </div>\
            <table class="media-table" contentEditable="false">\
              <tbody>\
                <tr>\
                  <td class="media-table-add">\
                    <div>\
                      Click to add image here\
                    </div>\
                  </td>\
                  <td style="width: 200px\; padding: 0 16px\;">\
                    ' + imgWrap + '\
                  </td>\
                  <td class="media-table-add">\
                    <div>\
                      Click to add image here\
                    </div>\
                  </td>\
                </tr>\
              </tbody>\
            </table>\
            <div class="media-caption just-title">\
              <div class="media-training-wheels">\
                <div class="media-tw-close">X</div>\
                <div class="media-tw-header">What\'s this?</div>\
                <div class="media-tw-explanation">\
                  By adding either a title or a caption, you\'ve turned the image into a "Figure".  To remove the figure label and number, \
                  remove any caption and title you\'ve added, and then click the <img src="content_files/broom-02.png" style="vertical-align: middle\;">\
                  broom icon that will appear next to the label.\
                  <a href="#asdfj890" class="media-tw-close-2">Don\'t show this message again.</a>\
                </div>\
              </div>\
              <span class="cnx_label"><span class="cnx_label_text">Figure 1</span><span class="clearer" title="Remove the \'Figure\' formatting, reverting to a unnumbered image."></span></span>\
              <span class="media-caption-removable">\
                <span class="hint-text">Add a caption for this image (optional)</span>\
                <span class="media-caption-close">X</span>\
              </span>\
              <div style="clear: both\;"></div>\
            </div>\
          </div>\
          ');
        } else {
          // As a subfigure next to an existing one 
          if (div.closest("td").index() == 0) {
            div.closest("td").after('<td style="width: 200px\; padding: 0 16px\;">' + imgWrap + '</td>');
          } else {
            div.closest("td").before('<td style="width: 200px\; padding: 0 16px\;">' + imgWrap + '</td>');
          }
        }
        resetImageDialogs();
        unSelectIcon($("#toolbar-image"),$(this).data('e'));


            }
          }
        }
      },
      Cancel: function() {
        $(this).dialog( "close" );
        unSelectIcon($("#toolbar-image"),$(this).data('e'));
        resetImageDialogs();
      }
    }
  });

  $("#image-options-step-2").dialog({
    width: 700,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
//      $(this).data("table").addClass("element-being-edited");
    },
    close: function(){
//      $(this).data("table").removeClass("element-being-edited");
/*
        resetImageDialogs();
        unSelectIcon($("#toolbar-image"),$(this).data('e'));
*/
    },
    buttons: {
      "Back": {
        text: 'Back',
        class: 'dialog-back', 
        click: function() {
          $(this).dialog( "close" );
          $("#image-options").dialog("open");
        }
      }, 
      "Insert": function() {
        $(this).dialog( "close" );
        var div = $(this).data("div");
        var alt = $("#enter-alt textarea").val().trim();
        var altwarn = '';
        if (alt == '') {
          altwarn = '<img class="alt-warning" src="content_files/warning-01.png" title="This image is missing a description for the visually impaired.  Click to provide one." contentEditable="false"/>';
        }
        var selectedImg = $("#drag-image").css("background-image").trim();
        if (selectedImg.charAt(4) == "'" || selectedImg.charAt(4) == '"') {
          selectedImg = selectedImg.substring(5,selectedImg.length - 2);
        } else {
          selectedImg = selectedImg.substring(4,selectedImg.length - 1); // Chrome doesn't include quotes as part of .css("background-image"), apparently
        }
        selectedImg = '<img src="' + selectedImg + '" class="image content-editable" contenteditable="true" width="200" alt="' + alt + '"/>'; // The width for KEF.
        var imgWrap = '<span class="media-inner content-editable" contentEditable="true">\
          ' + selectedImg + altwarn + '\
          <div class="image-options" contenteditable="false">\
            <span class="image-add-options">\
              <label class="image-options-add">Add:</label>\
              <a href="#asaefafedfas" class="image-options-title">Title</a>\
              &#183;\
              <a href="#asdfaasdfasdfs" class="image-options-caption">Caption</a>\
            </span>\
            <a href="#adsfasasdfas" class="image-options-options">\
              <img src="content_files/options-05.png" style="vertical-align: bottom\;"> \
              More options ...\
            </a>\
          </div>\
        </span>\
        ';
        if (div.attr("id") == "ImageNew") {
          // As a new figure somewhere in the document.
          div.replaceWith('\
          <div class="media-block">\
            <div class="media-title">\
              <span class="media-title-close">X</span>\
              <div class="hint-text">Add a title for this image (optional)</div>\
            </div>\
            <table class="media-table" contentEditable="false">\
              <tbody>\
                <tr>\
                  <td class="media-table-add">\
                    <div>\
                      Click to add image here\
                    </div>\
                  </td>\
                  <td style="width: 200px\; padding: 0 16px\;">\
                    ' + imgWrap + '\
                  </td>\
                  <td class="media-table-add">\
                    <div>\
                      Click to add image here\
                    </div>\
                  </td>\
                </tr>\
              </tbody>\
            </table>\
            <div class="media-caption just-title">\
              <div class="media-training-wheels">\
                <div class="media-tw-close">X</div>\
                <div class="media-tw-header">What\'s this?</div>\
                <div class="media-tw-explanation">\
                  By adding either a title or a caption, you\'ve turned the image into a "Figure".  To remove the figure label and number, \
                  remove any caption and title you\'ve added, and then click the <img src="content_files/broom-02.png" style="vertical-align: middle\;">\
                  broom icon that will appear next to the label.\
                  <a href="#asdfj890" class="media-tw-close-2">Don\'t show this message again.</a>\
                </div>\
              </div>\
              <span class="cnx_label"><span class="cnx_label_text">Figure 1</span><span class="clearer" title="Remove the \'Figure\' formatting, reverting to a unnumbered image."></span></span>\
              <span class="media-caption-removable">\
                <span class="hint-text">Add a caption for this image (optional)</span>\
                <span class="media-caption-close">X</span>\
              </span>\
              <div style="clear: both\;"></div>\
            </div>\
          </div>\
          ');
        } else {
          // As a subfigure next to an existing one 
          if (div.closest("td").index() == 0) {
            div.closest("td").after('<td style="width: 200px\; padding: 0 16px\;">' + imgWrap + '</td>');
          } else {
            div.closest("td").before('<td style="width: 200px\; padding: 0 16px\;">' + imgWrap + '</td>');
          }
        }
        resetImageDialogs();
        unSelectIcon($("#toolbar-image"),$(this).data('e'));
      },
      Cancel: function() {
        $(this).dialog( "close" );
        unSelectIcon($("#toolbar-image"),$("#image-options").data('e'));
        resetImageDialogs();
      }
    }
  });

  $("#enter-alt textarea").live("keyup", function(e){
    if ($(this).val().trim() != '') {
      $("#alt-warning-upload").hide();
    } else {
      $("#alt-warning-upload").show();
    }
  });

  function resetImageDialogs() {
      $("#ImageNew").remove();
      // Set form back to empty
      $("#drag-image").css("background-image","none");
      $("#drag-image").css("background-image","none");
      $("#upload-url").hide();
      $("#upload-url input[type='text']").val('');
//      $("#image-size").hide();
      $("#enter-alt textarea").val('');
      $("#alt-warning-upload").show();
//      $(".image-options-insert").addClass("disabled");
//      $(".image-options-insert").text("Insert");
      $("#image-options").removeData("ip");
      $("input[name='img-perms']").each(function(e){
        this.checked = false;
      });
      $("#img-perms-required").removeClass("warning");
//      $("#select-image-required").removeClass("warning");
      $("#drag-image").removeClass("warning3");
//      $("#reuse-info").hide();
      $("#reuse-author").val('');
      $("#reuse-url").val('');
      $("#reuse-license")[0].selectedIndex = 0;
      $("#include-in-footnote").attr("checked", true);
      $("#reuse-footnote-edit").attr("checked", false);
      $("#reuse-footnote-text").addClass("disabled");
      $("#reuse-footnote-text").attr("contentEditable","false");
      $("#reuse-footnote-text span").hide();
  }

  $("#link-options").dialog({
/* 
   TODO: 
   .cnxns
   "preview this link" link
   make newly-contstructed links editable and unlinkable
*/
    width: 600,
    autoOpen: false,
    modal: true,
    resizable: true,
    zIndex: 500,
    open: function(){
      var linkText = $(this).data("link").text();
      var linkURL = $(this).data("link").attr("href");
      $("#link-text-input").val(linkText);
      $("#ltw-webpage-url").val(linkURL);
      if (true) { // this clearly needs to change
        $("#ltw-webpage").attr("checked", true);
        $("#ltw-webpage-url").focus();
      } else {
        $("#ltw-place").attr("checked", true);
      }
      var lbl = '';
      var ttl = '';
      var txt = '';
      $(".section-header:visible, .figure:visible, .table:visible, .example:visible, .rule:visible, .note:visible, .exercise:visible, .equation:visible").each(function(e){
        // get label
        if ($(this).hasClass("equation")) {
          lbl = 'Equation ' + $(this).find(".equation-number").text().trim().replace('(','').replace(')','');
        } else if ($(this).hasClass("section-header")) {
          lbl = $(this).find(".cnx_label").text().trim() // doubtful that this will exist, but possible.
        } else if ($(this).hasClass("table")) {
          lbl = $(this).find(".table-text").find(".cnx_label").text().trim();
        } else if ($(this).hasClass("figure")) {
          lbl = $(this).find(".media-caption").find(".cnx_label").text().trim();
        } else {
          lbl = $(this).children().children("[class*='-header']").find(".cnx_label").text().trim();
        }
        if (lbl.length && lbl != '') {
          lbl = '<span class="cnx_label">' + lbl + ' </span>';
        } else {
          lbl = '';
        }
        // get title
        if ($(this).hasClass("section-header")) {
          ttl = $(this).find(".title").text().trim();
        } else if ($(this).hasClass("figure")) {
          ttl = $(this).find(".media-title-text").text().trim();
        } else {
          ttl = $(this).children().children("[class*='-header']").find(".title").clone().children().remove().end().text().trim(); // the .clone()....end() part to remove the 'Add a descriptive title' child
        }
        if (ttl.length && ttl != '') {
          ttl = '<strong class="title">' + ttl + ' </strong>';
        } else {
          ttl = '';
        }
        // get text
        if ($(this).hasClass("table")) {
//          txt = $(this).find("thead, tbody, tfoot").text().trim();
          txt = $(this).find("thead, tbody").text().trim();
        } else if ($(this).hasClass("section-header")) {
          txt = '';
        } else if ($(this).hasClass("equation")) {
          txt = '';
        } else if ($(this).hasClass("figure")) {
          txt = $(this).find(".media-caption-text").text().trim();
        } else {
          txt = $(this).children().children("[class*='-contents']").text().trim();
        }
        if (txt.length && txt != '') {
          txt = '<span class="txt">' + txt + '</span>';
        } else {
          txt = '';
        }
        // put it all together
        $("#link-parts").append('<div class="linkable-part">' + lbl + ttl + txt + '</div>');
        var classes = new Array("section-header","figure","table","example","rule","note","exercise","equation");
        for (var i=0; i < classes.length; i++) {
          if ($(this).hasClass(classes[i])) {
            $(".linkable-part").last().addClass("linkable-" + classes[i]);
          }
        }
      });
    },
    close: function(){
      // remove the hooks used to identify the currently-edited link
      $("#LinkNew").removeAttr("id");
      $(".LinkNew").removeClass("LinkNew");
      // reset values to default/empty
      $("#link-text-input").val('');
      $("#ltw-webpage-url").val('');
      $("#ltw-webpage-url").removeClass("disabled");
      $("#ltw-webpage-url").removeProp("disabled");
      $("#ltw-webpage").attr("checked", false);
      $("#ltw-place").attr("checked", false);
      $("#link-parts").empty();
      $("#link-parts").addClass("disabled");
      $("#link-parts-filters li").removeClass("selected");
      // return the toolbar icon to normal
      unSelectIcon($("#toolbar-link"),$("#link-options").data('e'));
    },
    buttons: {
      "Submit": {
        text: 'Submit',
        class: '', 
        click: function() {
          // apply the new link values
          var newLinkText = $("#link-text-input").val();
          var newLinkURL = $("#ltw-webpage-url").val();
          $("#LinkNew, .LinkNew").replaceWith('<a href="' + newLinkURL + '">' + newLinkText + '</a>')
          // Close the dialog (and everything that entails);
          $(this).dialog( "close" );
        }
      },
      Cancel: function() {
        $(this).dialog( "close" );
      }
    }
  });

  $("#link-parts, #link-parts-filters, #ltw-place").on("click", function(e){
    $("#ltw-place").attr("checked", true);
    $("#link-parts").removeClass("disabled");
    if (this.id == 'ltw-place') {
      $("#lp-all").click();
    }
    $("#ltw-webpage-url").addClass("disabled");
    $("#ltw-webpage-url").prop("disabled", true);
  });
  $("#ltw-place").on("click", function(e){
    $("#ltw-place").attr("checked", true);
    $("#link-parts").removeClass("disabled");
  });

  $(".linkable-part").live("mouseenter", function(e){
    $(this).addClass("hovered");
  });
  $(".linkable-part").live("mouseleave", function(e){
    $(this).removeClass("hovered");
  });
  $(".linkable-part").live("click", function(e){
    $(".linkable-part.selected").removeClass("selected");
    $(this).addClass("selected");
    $("#ltw-place").attr("checked", true);
    if (!$("#link-parts-preview").length) {
      $("#link-parts").after('<div id="link-parts-preview"><a href="#">Preview this link</a></div>');
    }
  });
  $("#ltw-webpage, #ltw-webpage-url").live("click", function(e){
    $(".linkable-part").removeClass("selected");
    $("#ltw-webpage").attr("checked", true);
    $("#ltw-webpage-url").removeClass("disabled");
    $("#ltw-webpage-url").prop("disabled", false);
    $("#link-parts").addClass("disabled");
    $("#link-parts-filters li").removeClass("selected");
    $("#link-parts-preview").remove();
  });
  $("#link-parts-preview a").live("click", function(e){
    return false;
  });
  $("#ltw-webpage-test a").live("click", function(e){
    window.open($("#ltw-webpage-url").val(), '_blank', 'width=800, height=600');
    return false;
  });

  $("#link-parts-filters li").live("click", function(e){
    var filter = this.id.substring(3,this.id.length - 1); // e.g. convert "lp-headers" to "header"
    if (filter != 'heade') { // "Show:"
      $("#link-parts .nothing-to-display").remove();
      $(".linkable-part").removeClass("selected");
      $("#link-parts-preview").remove();
      $("#link-parts div").hide();
      $("#link-parts-filters .selected").removeClass("selected");
      $(this).addClass("selected");
      if (filter == 'al') {  // "All"
        $("#link-parts div").show();
        if (!$("#link-parts div").length) {
          $("#link-parts").append('<div class="nothing-to-display">There are no other elements to link to</div>');
        }
      } else if (filter == 'othe') { // "Other"
        $("#link-parts .linkable-rule, #link-parts .linkable-exercise, #link-parts .linkable-note, #link-parts .linkable-equation, #link-parts .linkable-example").show();
        if (!$("#link-parts .linkable-rule, #link-parts .linkable-exercise, #link-parts .linkable-note, #link-parts .linkable-equation, #link-parts .linkable-example").length) {
          $("#link-parts").append('<div class="nothing-to-display">There are no other elements to link to</div>');
        }
      } else {
        var filter2 = "#link-parts div.linkable-" + filter;
        $(filter2).show();
        if (!$(filter2).length) {
          if (filter == "section-header") {
            $("#link-parts").append('<div class="nothing-to-display">There are no section headings to link to</div>');
          } else {
            $("#link-parts").append('<div class="nothing-to-display">There are no ' + filter + 's to link to</div>');
          }
        }
      }
    }
  });

  $("#ascii-or-latex").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
    },
    close: function(){
        $(this).data("e").stopPropagation();
    },
    buttons: {
      "OK": function() {
        $(this).dialog( "close" );
        var aol = $("input[name=ascii-or-latex-radio]:checked").attr("id");
        $("[class*='-header']").die("mouseenter mouseleave"); // Turning hovers off (temporarily)
        $(".canvas-wrap").die("mouseenter mouseleave"); // Have to do this one separately from above, apparently
        $(".MathJax").die("mouseenter mouseleave");
        $("table caption").die("mouseenter mouseleave");
        cwLeave($(".canvas-wrap"),"special");
//        mathEditorRemove();
        $("#toolbar-math").addClass("selected");
        var e = $(this).data("e");
        var exText = $(this).data("exText");
        mathClickNew2(aol,exText,e);
        e.stopPropagation();
      },
      Cancel: function() {
        $(this).dialog( "close" );
        var exText = $(this).data("exText");
        if (exText.trim() == '&nbsp\;') {
          $("#MathJaxNew").remove();
        } else {
          $("#MathJaxNew").replaceWith(exText);
        }
        $("#toolbar-math").removeClass("selected");
        e.stopPropagation();
      }
    }
  });

/*
  $("em.emphasis,dfn.term").addClass("edhint");
*/

  $("#hints-checkbox").click(function(e){
/*
    if ( $(this).is(":checked") ) {
      $("em.emphasis,dfn.term").addClass("edhint");    
    } else {
      $("em.emphasis,dfn.term").removeClass("edhint");
    }
*/
    if ( $(this).is(":checked") ) {
      $("#hints").addClass("selected");
      cthEnter($(".convert-to-header, .section-header"),e);
      $(".convert-to-header, .section-header").die("mouseenter mouseleave")
    } else {
      $("#hints").removeClass("selected");
      cthLeave($(".convert-to-header, .section-header"),e);
      $(".convert-to-header, .section-header").live("mouseenter", function(e){
        cthEnter($(this),e);
      });
      $(".convert-to-header, .section-header").live("mouseleave", function(e){
        cthLeave($(this),e);
      });
    }
    e.stopPropagation();
  });


/*
  $(".convert-to-header").live("mouseenter", function(e){
    if (!$(this).find(".cth-list").length) {
      $(this).children("em.emphasis").append('<span class="edhint" contentEditable="false"><img src="helper_files/math-hint-03.png"/></span>');
    }
  });
  $(".convert-to-header").live("mouseleave", function(e){
    $(this).children("em.emphasis").children('.edhint').remove();
  });
*/
  function cthEnter(cth,e) {
    if (!cth.find(".cth-list").length) {
      cth.children().append('<span class="edhint" contentEditable="false"><img src="helper_files/math-hint-03.png"/></span>');
    }
  }
  function cthLeave(cth,e) {
    cth.children().children('.edhint').remove();
  }
  $(".convert-to-header, .section-header").live("mouseenter", function(e){
    cthEnter($(this),e);
  });
  $(".convert-to-header, .section-header").live("mouseleave", function(e){
    cthLeave($(this),e);
  });

  $(".convert-to-header .edhint, .section-header .edhint").live("click", function(e){
    if ($(this).next(".cth-list").length) {
      $(this).next(".cth-list").remove();
    } else {
      $(this).after('<ul class="cth-list" contentEditable="false"></ul>')
      $(this).next(".cth-list").append('<li class="cth-list-help"><a href="#">(?)</a>Make the above text:</li>');
      $(this).next(".cth-list").append('<li class="cth-list-help-text-wrap">\
          <div class="cth-list-help-text">\
            <span class="cth-list-help-text-close">x</span>\
            <p>\
              Section headings help readers understand the flow of the content and help visually-impaired learners listen to the document. \
              Section headings show up in the table of contents and you can easily make links to them.\
            </p>\
            <p>\
              <strong>Why did this show up here?</strong>\
            </p>\
            <p>\
              The text above this menu is a line of bold text. Often bold suggests a section heading. This menu provides a quick way to convert to a heading (or back to plain text).\
            </p>\
          </div>\
      ');
//      var emText = $(this).closest(".convert-to-header").find("em.emphasis").clone().children().remove().end().text();
      var ish2 = $(this).closest("h2").length ? true : false;
      var ish3 = $(this).closest("h3").length ? true : false;
      var prevh2 = ish2 ? $(this).add($("h2.section-header:visible")).index($(this)) - 1 : $(this).add($("h2.section-header:visible")).index($(this));
      var prevh3 = ish3 ? $(this).add($("h3.section-header:visible")).index($(this)) - 1 : $(this).add($("h3.section-header:visible")).index($(this));
      $(this).next(".cth-list").append('<li class="cth-list-item cth-list-h2"><span class="cth-level">Section heading</span></li>');
      // if ($(this).preceding("h2.section-header").length)
//      if ($(this).add($("h2.section-header:visible")).index($(this))) {
      $(this).next(".cth-list").append('<li class="cth-list-item cth-list-h3 disabled" title="You cannot add a subsection at this level of the document"><span class="cth-level">Subsection heading</span></li>');
      if (prevh2 > 0) {
        $(this).next(".cth-list").find(".cth-list-h3").removeClass("disabled");
        $(this).next(".cth-list").find(".cth-list-h3").removeAttr("title");
      }
//      if ($(this).add($("h3.section-header:visible")).index($(this))) {
      $(this).next(".cth-list").append('<li class="cth-list-item cth-list-h4 disabled" title="You cannot add a subsubsection at this level of the document"><span class="cth-level">Subsubsection heading</span></li>');
      if (prevh3 > 0) {
        $(this).next(".cth-list").find(".cth-list-h4").removeClass("disabled");
        $(this).next(".cth-list").find(".cth-list-h4").removeAttr("title");
      }
      $(this).next(".cth-list").append('<li class="cth-list-item cth-list-regular"><span class="cth-level">Plain bold text</span></li>');
      if ($(this).closest(".section-header:visible").length) {
        $(this).next(".cth-list").find("cth-list-regular").removeClass("disabled");
      }
      if ($(this).closest("h2:visible").length) {
        $(this).next(".cth-list").find(".cth-list-h2").addClass("selected");
      } else if ($(this).closest("h3:visible").length) {
        $(this).next(".cth-list").find(".cth-list-h3").addClass("selected");
      } else if ($(this).closest("h4:visible").length) {
        $(this).next(".cth-list").find(".cth-list-h4").addClass("selected");
      } else {
        $(this).next(".cth-list").find(".cth-list-regular").addClass("selected");
      }
      $(this).closest(".convert-to-header, .section-header").find(".edhint").remove();
    }
  });

  $(".cth-list-item").live("click", function(e){
    var cvt = $(this).closest(".convert-to-header, .section-header");
    var cls = $(this).attr("class");
    var level = cls.substring(cls.length -2, cls.length); // may result in "ar" for regular text, as opposed to h2, h3, h4
    cvt.find(".cth-list").remove();
    cvt.find(".edhint").remove();
    var content = cvt.children("em.emphasis, .title").contents();
    if (level == 'ar') { // Change back to regular text
      content.unwrap().unwrap().wrap('<div class="para content-editable convert-to-header" contenteditable="true"><em class="emphasis"></em></div>');
    } else {
      content.unwrap().unwrap().wrap('<' + level + ' class="section-header"><strong class="title content-editable" contenteditable="true"></strong></' + level + '>');
    }
    content.parent().parent().effect("highlight", { color: "#C5DAE9" }, 800);
    if ($("#hints-checkbox").is(":checked")) {
      cthEnter(content.closest(".convert-to-header, .section-header"),e);
    }
  });

  $(".cth-list").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        $(this).remove();
      },
      timeout: 600,
    });
  });
  $(".convert-to-header, .section-header").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        $(this).find(".cth-list").remove();
      },
      timeout: 500,
    });
  });



  function imageOptionsPlacement(img,io,e) {
    // this centers the .image-options box under 
    var iow = io.outerWidth();
    var imgw = img.outerWidth();
/*
    if (imgw > iow) {
      io.css("left","0");
    } else {
*/
      io.css("left", (iow / 2 - imgw / 2) * -1 );
/*
    }
*/
  }

/*
  $(".media-inner").resizable({
    aspectRatio: true,
    start: function(e){
      console.log("asdf");
    },
    handles: "n, e, s, w, ne, se, sw, nw",
    helper: "image-resize",
    containment: "parent",
  });
*/

/*
  $(".media-inner").mousemove(function(e){
      var io = $(this).children(".image-options");
      imageOptionsPlacement($(this).children(".image"),io,e);
      io.show();
  });
*/

  function mediaInnerEnter(mi,e){
    var io = mi.children(".image-options");
    imageOptionsPlacement(mi.children(".image"),io,e);
    io.show();
  }
  function mediaInnerLeave(mi,e){
    mi.children(".image-options").hide();
  }
  $(".media-inner").live("mouseenter", function(e){
    mediaInnerEnter($(this),e);
  });
  $(".media-inner").live("mouseleave", function(e){
    mediaInnerLeave($(this),e);
  });


/*
  $(".media-inner").hoverIntent({
    over: function(e){
      var io = $(this).children(".image-options");
      imageOptionsPlacement($(this).children(".image"),io,e);
      io.show();
    },
    out: function(e){
      $(this).children(".image-options").hide();
    },
    timeout: 400,
  });
*/

  $(".image-options-options, .image-options .already-added").live("click", function(e){
    return false;
  });

  function imageOptionsTitleOrCaption(iol,mb,mi) {
    mi.off("mouseenter"); // Temporarily turning off so that this doesn't pop open again when things are moving around
    if (!iol.closest(".canvas-wrap").children(".figure").length) {
      mb.wrap('<div class="canvas-wrap" contenteditable="false"><div class="figure canvas canvas-hovered"><div class="canvas-inner"></div></div></div>')
      addHandles(iol.closest(".canvas-wrap"));
    }
    iol.closest(".canvas-inner").children(".canvas-buddy, .canvas-buddy-2").show();
    iol.closest(".image-options").hide();
    iol.addClass("already-added");
    iol.attr("title","This has already been added");
  }

  $(".image-options-title:not('.already-added')").live("click", function(e){

    var mb = $(this).closest(".media-block");
    var mi = $(this).closest(".media-inner");
    imageOptionsTitleOrCaption($(this),mb,mi);
    var mt = mb.find(".media-title");
    mt.addClass("hovered");
    mt.find(".media-title-close").show();

    var mc = mb.find(".media-caption");
    if (mc.hasClass("just-title")) {
      mc.slideDown("fast", function(e){
        var mcb = mc.offset().top + mc.outerHeight();
        var sb = $(window).scrollTop() + $(window).height();
        if (mcb > sb) {
          $('body,html').animate({
            scrollTop: mcb - $(window).height() + 10, // I got confused here, so adding an extra 10 which makes it seem to work :-p
          }, 500);
        }
/*
        mi.on("mouseenter", function(e){ // Turning back on
          mediaInnerEnter(mi,e);
        });
*/
      });
    }

    mt.slideDown("fast", function(e){

      var imgw = mb.find(".image").outerWidth();
      if (mt.outerWidth() < imgw) mt.css("width",imgw - 28 + "px");
      mi.on("mouseenter", function(e){ // Turning back on
        mediaInnerEnter(mi,e);
      });
    });

    return false;

  });

  $(".image-options-caption:not('.already-added')").live("click", function(e){

    var mb = $(this).closest(".media-block");
    var mi = $(this).closest(".media-inner");
    imageOptionsTitleOrCaption($(this),mb,mi);
    var mc = mb.find(".media-caption");
/*
    if (!mc.hasClass("just-title")) {
*/

      mc.removeClass("just-title");

      var mcl = mc.find(".cnx_label_text");
      var mclt = mcl.text().trim();
      if (mclt.substr(mclt.length - 1) != ":") {
        mcl.text(mclt + ": ");
      }

      mc.addClass("hovered");
      mc.find(".media-caption-close").show();
      mc.slideDown("fast", function(e){

        var sb = $(window).scrollTop() + $(window).height();
        var mcb = mc.offset().top + mc.outerHeight();
        if (mcb > sb) {
          $('body,html').animate({
            scrollTop: mcb - $(window).height() + 10, // I got confused here, so adding an extra 10 which makes it seem to work :-p
          }, 500);
        }
  
        mi.on("mouseenter", function(e){ // Turning back on
          mediaInnerEnter(mi,e);
        });
      
      });

/*
    } else {
      mc.removeClass("just-title");
    }
*/

    return false;

  });

  $(".media-caption").live("click", function(e){
    if (!$(this).hasClass("just-title")) {
      if (!$(this).find(".media-caption-text").length) {
        $(this).find(".hint-text").remove();
        $(this).find(".media-caption-removable").append('<span class="content-editable media-caption-text" contentEditable="true"></span>');
      }
      $(this).find(".media-caption-text").focus();
    }
    return false;
  });
  $(".media-caption").on("mouseenter", function(e){
    $(this).addClass("hovered");
    $(this).find(".media-caption-close").show();
  });
  $(".media-caption").on("mouseleave", function(e){
    $(this).removeClass("hovered");
    var mct = $(this).find(".media-caption-text");
    if (mct.length && mct.text().trim() == '') {
      mct.remove();
      $(this).find(".media-caption-removable").append('<span class="hint-text">Add a caption for this image (optional)</span>');
    }
    $(this).find("*").blur();
    $(this).blur();
    $(this).find(".media-caption-close").hide();
  });
  $(".media-caption-close").live("click", function(e){
    var mb = $(this).closest(".media-block");
    var mc = $(this).closest(".media-caption");
//    mc.slideUp();
    var mclt = mc.find(".cnx_label_text").text().trim();
    if (mclt.substr(mclt.length - 1) == ":") {
      mc.find(".cnx_label_text").text(mclt.substring(0, mclt.length - 1));
    }
    mc.addClass("just-title");
    mc.addClass("hovered");
    if(mc.find(".media-caption-text").length) {
      mc.find(".media-caption-text").remove();
      mc.find(".media-caption-removable").append('<span class="hint-text">Add a caption for this image (optional)</span>');
    }
    mb.find(".image-options-caption").removeClass("already-added");
    mb.find(".image-options-caption").removeAttr("title");

    mc.find(".media-training-wheels").slideUp("fast", function(e){
      $(this).remove();
    });

    if (mb.find(".media-title").css("display") == 'none') {
       mc.find(".cnx_label").addClass("clear active");
    }

    return false;
  });
  $(".media-title").live("click", function(e){
//    $(this).removeClass("empty");
    if (!$(this).find(".media-title-text").length) {
      $(this).find(".hint-text").remove();
      $(this).append('<span class="content-editable media-title-text" contentEditable="true"></span>');
    }
    $(this).find(".media-title-text").focus();
    return false;
  });
  $(".media-title").on("mouseenter", function(e){
    $(this).addClass("hovered");
    $(this).find(".media-title-close").show();
  });
  $(".media-title").on("mouseleave", function(e){
    $(this).removeClass("hovered");
    var mtt = $(this).find(".media-title-text");
    if (mtt.length && mtt.text().trim() == '') {
      mtt.remove();
//      $(this).addClass("empty");
      $(this).append('<span class="hint-text">Add a title for this image (optional)</span>');
    }
    $(this).find("*").blur();
    $(this).blur();
    $(this).find(".media-title-close").hide();
  });
  $(".media-title-close").live("click", function(e){
    var mb = $(this).closest(".media-block");
    $(this).parent().slideUp();
    $(this).parent().addClass("hovered");
    if($(this).siblings(".media-title-text").length) {
      $(this).siblings(".media-title-text").remove();
      $(this).parent().append('<span class="hint-text">Add a title for this image (optional)</span>');
    }
    mb.find(".image-options-title").removeClass("already-added");
    mb.find(".image-options-title").removeAttr("title");

    if (mb.find(".media-caption").hasClass("just-title")) {
       mb.find(".cnx_label").addClass("clear active");
    }

    return false;
  });

  $(".media-tw-close, .media-tw-close-2").live("click", function(e){
    $(this).closest(".media-training-wheels").slideUp("fast", function(e){
      $(this).remove();
    });
    return false;
  });

  $(".clear").live("mouseenter", function(e){ // dunno why .on() doesn't work!
    $(this).addClass("active");
  });
  $(".clear").live("mouseleave", function(e){
    $(this).removeClass("active");
  });
  $(".clearer").on("mouseenter", function(e){
    $(this).siblings(".cnx_label_text").css("visibility","hidden");
    $(this).closest(".media-caption").css("border-top-color","transparent");
    cwLeave($(this).closest(".canvas-wrap"),e);
  });
  $(".clearer").on("mouseleave", function(e){
    $(this).siblings(".cnx_label_text").css("visibility","visible");
    $(this).closest(".media-caption").css("border-top-color","#999");
    cwEnter($(this).closest(".canvas-wrap"),e);
  });
  $(".clearer").on("click", function(e){
    $(this).closest(".canvas-inner").find(".canvas-buddy, .canvas-buddy-2").remove();
    $(this).closest(".canvas-inner").children().unwrap().unwrap().unwrap();
    $(this).parent().removeClass("clear active");
    $(this).siblings(".cnx_label_text").css("visibility","visible");
    $(this).closest(".media-caption").css("border-top-color","#999");
    $(this).closest(".media-caption").hide();
  });

/*
  $(".image-options-inline").live("click", function(e){
    if ($(this).hasClass("not-selected")) {
      $(this).removeClass("not-selected");
      $(this).addClass("selected");
      $(this).siblings(".image-options-block").removeClass("selected");
      $(this).siblings(".image-options-block").addClass("not-selected");
      var mb = $(this).closest(".media-block");
      mb.addClass("inline");
      mb.find(".media-title").hide();
      mb.find(".media-caption").hide();
//      mb.find(".image-add-options").hide();
      mb.find(".image-add-options").addClass("disabled");
      mb.find(".image-add-options").attr("title","These options are disabled when the image is positioned inline with text");
    }
    return false;
  });
  $(".image-options-block:not('.selected')").live("click", function(e){
    if ($(this).hasClass("not-selected")) {
      $(this).removeClass("not-selected");
      $(this).addClass("selected");
      $(this).siblings(".image-options-inline").removeClass("selected");
      $(this).siblings(".image-options-inline").addClass("not-selected");
      var mb = $(this).closest(".media-block");
      mb.removeClass("inline");
//      mb.find(".image-add-options").show();
      mb.find(".image-add-options").removeClass("disabled");
      mb.find(".image-add-options").find("a").removeAttr("title");
    }
    return false;
  });
*/

  $(".alt-warning").live("click", function(e){
/*
    $(this).siblings(".image").removeAttr("contentEditable").blur();
    $(this).parent().removeAttr("contentEditable").blur();
    $("*[contentEditable]").removeAttr("contentEditable").blur();
*/
    $("#alt-text").data("alt-warning",$(this)).dialog("open");
    return false;
  });

  $("#alt-text").dialog({
    width: 600,
    autoOpen: false,
    modal: true,
    zIndex: 500,
    open: function(){
    },
    close: function(){
    },
    buttons: {
      "OK": function() {
        $(this).dialog( "close" );
        var altEntered = $("#alt-text").find("textarea").val().trim();
        $("#alt-text").find("textarea").val('');
        if (altEntered.length) {
          $(this).data("alt-warning").replaceWith('<span id="thanks">Thanks!</span>');
          $("#thanks").fadeOut(1450, function(e){
            $(this).remove();
          });
        }
        return false;
      },
      Cancel: function() {
        $(this).dialog( "close" );
        $("#alt-text").find("textarea").val('');
        return false;
      }
    }
  });


  $(".media-table-add").live("mouseenter", function(e){
        if ($(this).outerWidth() > 172) {
          $(this).siblings(".media-table-add").find("div").css({
            "display": "block",
            "visibility": "hidden",
          })
          $(this).find("div").show();
        }
  });
  $(".media-table-add").live("mouseleave", function(e){
        $(this).find("div").hide();
        $(this).siblings(".media-table-add").find("div").css({
          "display": "none",
          "visibility": "visible",
        })
  });

/*
  $(".media-table-add").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
      },
      interval: 300,
    });
  });
*/

  $(".link, .cnxn").live("click", function(e){
//    $("#toolbar-unlink").removeClass("disabled");
    href = $(this).attr("href");
    $(this).append('\<div class="link-options" contenteditable="false">\
        <div class="link-information">\
          <img src="content_files/pencil_cnx.png" />\
          <a href="#" class="edit-link"><span class="sprite" title="Edit link"></span>Edit link</a> |\
          <img src="helper_files/external-link-02.png"/> <a href="' + href + '" target="_blank" class="visit-link">' + href + '</a> |\
          X <a href="#" class="unlink-link"><span class="sprite" title="Unlink (remove the link, leaving just the text)"></span>Unlink</a>\
        </div>\
      </div>');
    return false;
  });

  $(".link-options").live("click", function(e){
    return false;
  });

  $(".visit-link").live("click", function(e){
    window.open($(this).attr("href"), "_blank");
    return false;
  });

  $("#canvas").on("mouseup", function(e){
    activateToolbar(e);
  });
  $("#canvas").on("keyup", function(e){
    var key = e.keyCode || e.which;
    if (key == 37 || key == 38 || key == 39 || key == 40) {
      activateToolbar(e);
    }
  });

  // Turn different things on and off in toolbar depending on cursor location (currently only on mouseup, not arrow movements)
  function activateToolbar(e) {
    var cn = $(getSelectionContainerElement());
    if (cn.closest(".edhint").length) { // I don't think this is even going to work since .edhint is generated by JS and getSelectionContainerElement() doesn't do well with JS-generated elements
      $("#toolbar-bold").removeClass("selected");
      e.stopPropagation();
    } else {
/*
      if (cn.closest(".link").length || cn.closest(".cnxn").length) {
        $("#toolbar-unlink").removeClass("disabled");
      } else {
        $("#toolbar-unlink").addClass("disabled");
      }
*/
      if (cn.closest(".term").length || cn.closest(".emphasis").length) {
        $("#toolbar-bold").addClass("selected");
      } else {
        $("#toolbar-bold").removeClass("selected");
      }
    }
  }

  $(".solution-toggle").live("click", function(e){
    var exer = $(this).closest(".exercise");
    var sol = exer.find(".solution").parent();
    var sts = exer.find(".solution-toggle-show");
    if (sol.is(":hidden")) {
      sts.slideUp("fast");
      sol.slideDown("fast");
    } else {
      sts.slideDown("fast");
      sol.slideUp("fast");
    }
  });
  $(".solution-toggle-hide").live("mouseover", function(e){
    $(this).attr("title","When viewed on the web, solutions will be hidden by default.  Click here to preview how that will appear.");
  });
  $(".answer-toggle").live("click", function(e){
    var ques = $(this).closest(".question");
    var ans = ques.find(".solution").parent();
    var ats = ques.find(".answer-toggle-show");
    if (ans.is(":hidden")) {
      ats.slideUp("fast");
      ans.slideDown("fast");
    } else {
      ats.slideDown("fast");
      ans.slideUp("fast");
    }
  });
  $(".answer-toggle-hide").live("mouseenter", function(e){
    $(this).attr("title","When viewed on the web, answers will be hidden by default.  Click here to preview how that will appear.");
  });

  $("#image-dialog-title .hint-link, #image-dialog-caption .hint-link").live("click", function(e){
    $(this).hide();
    $(this).siblings().show();
    $(this).siblings().children().eq(1).focus();
  });

  $("#image-dialog-title-close, #image-dialog-caption-close").live("click", function(e){
    $(this).parent().hide();
    $(this).siblings().text('\xa0');
    $(this).parent().parent().children(".hint-link").show();
  });


  $(".exercise-header>.cnx_label").live("click", function(e){
    $("[class*='-header']").die("mouseenter mouseleave");
    var num = $(this).text().match(/[0-9]+/);
    var label = $(this).text().trim().split(" ")[0];
    $(this).parent().append('<span class="label-list">\
      <span class="cnx_label">Exercise</span>\
      <span class="cnx_label">Homework</span>\
      <span class="cnx_label">Problem</span>\
      <span class="cnx_label">Question</span>\
      <span class="cnx_label">Task</span>\
    </span>\
    ');
    $(this).parent().find(".label-list .cnx_label").each(function(e){
      var txt = $(this).text().trim();
      if (label == txt) $(this).addClass("current");
      $(this).text(txt + " " + num);
    });
  });
  $(".exercise-header").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        removeLabelList();
      },
      timeout: 500,
    });
  });
  $(".exercise-header .label-list .cnx_label").live("click", function(e){
    var txt = $(this).text()
    $(this).closest(".exercise-header").children(".cnx_label").text(txt);
    removeLabelList();
  });

  $(".solution-header>.cnx_label").live("click", function(e){
    $("[class*='-header']").die("mouseenter mouseleave");
    var label = $(this).text().trim().split(" ")[0];
    $(this).parent().append('<span class="label-list">\
      <span class="cnx_label">Solution</span>\
      <span class="cnx_label">Answer</span>\
    </span>\
    ');
    $(this).parent().find(".label-list .cnx_label").each(function(e){
      var txt = $(this).text().trim();
      if (label == txt) $(this).addClass("current");
    });
  });
  $(".solution-header").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        removeLabelList();
      },
      timeout: 500,
    });
  });
  $(".solution-header .label-list .cnx_label").live("click", function(e){
    var txt = $(this).text()
    $(this).closest(".solution-header").children(".cnx_label").text(txt);
    $(this).closest(".exercise").find(".solution-toggle-show").find(".solution-toggle").text("[ Show " + txt + " ]");
    $(this).closest(".exercise").find(".solution-toggle-hide").find(".solution-toggle").text("[ Hide " + txt + " ]");
    removeLabelList();
  });

  $(".note-header>.cnx_label").live("click", function(e){
    $("[class*='-header']").die("mouseenter mouseleave");
    var label = $(this).text().trim().split(" ")[0].split(":")[0];
    $(this).parent().append('<span class="label-list">\
      <span class="cnx_label">Note</span>\
      <span class="cnx_label">Aside</span>\
      <span class="cnx_label">Warning</span>\
      <span class="cnx_label">Tip</span>\
      <span class="cnx_label">Important</span>\
    </span>\
    ');
    $(this).parent().find(".label-list .cnx_label").each(function(e){
      var txt = $(this).text().trim();
      if (label == txt) $(this).addClass("current");
    });
  });
  $(".solution-header").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        removeLabelList();
      },
      timeout: 500,
    });
  });
  $(".note-header .label-list .cnx_label").live("click", function(e){
    var txt = $(this).text()
    $(this).closest(".note-header").children(".cnx_label").text(txt);
    removeLabelList();
  });

  $(".example-header>.cnx_label").live("click", function(e){
    $("[class*='-header']").die("mouseenter mouseleave");
    var num = $(this).text().match(/[0-9]+/);
    var label = $(this).text().trim().split(" ")[0];
    $(this).parent().append('<span class="label-list">\
      <span class="cnx_label">Example</span>\
      <span class="cnx_label">Case in point</span>\
      <span class="cnx_label">Demonstration</span>\
      <span class="cnx_label">Illustration</span>\
    </span>\
    ');
    $(this).parent().find(".label-list .cnx_label").each(function(e){
      var txt = $(this).text().trim();
      if (label == txt) $(this).addClass("current");
      $(this).text(txt + " " + num);
    });
  });
  $(".example-header").livequery(function(){
    $(this).hoverIntent({
      over: function(e){
      }, 
      out: function(e){
        removeLabelList();
      },
      timeout: 500,
    });
  });
  $(".example-header .label-list .cnx_label").live("click", function(e){
    var txt = $(this).text()
    $(this).closest(".example-header").children(".cnx_label").text(txt);
    removeLabelList();
  });

  function removeLabelList(ll,e) {
    $(".label-list").remove();
    $("[class*='-header']").live("mouseenter", function(e){
      headerEnter($(this),e);
    });
    $("[class*='-header']").live("mouseleave", function(e){
      headerLeave($(this),desctitle,e);
    });
  }

});

</script>


<style type="text/css">

#editor{
  background-color: #bbb;
  background-color: #c7c7c7;
  background-color: #ccc;
}
#content{
  padding-left: 0em;
  padding-right: 0em;
  padding-bottom: 0em;
padding-top: 0;
}
#pageheader-wrap{
  margin-top: -10px;
  margin-left: 2em;
  margin-right: 2em;
display: none;
}

#workflownav-wrap, #header-wrap{
  display: none;
}

#toolbar{
  height: 42px;
  background-image: url(toolbar/toolbar-bg-01.png);
  background-repeat: repeat-x;
  background-position: 0 0;
  background-color: #fff;
  padding: 0 1em;
  border-bottom: 1px solid #aaa;
  position: relative;
  z-index: 1;
clear: both;
  white-space: nowrap;
position: fixed;
top: 0;
width: 100%;
z-index: 550;
  box-shadow: 0 0 5px #bbb;
  font-size: .9em;
  font-family: tahoma,verdana,arial,helvetica,sans-serif;

  /* following two are part of a hack learned from PatrikAkerstrand at http://stackoverflow.com/questions/5078239/how-to-remove-the-space-between-inline-block-elements */
  letter-spacing: -.31em;
  word-spacing: -.43em;
}

#icon-set{
  padding: 4px 0;
}
.toolbar-function{
  position: relative;
  letter-spacing: normal;
  word-spacing: normal;
  height: 33px;
  width: 33px;
  display: inline-block;
}
.toolbar-icon{
  background-image: url(toolbar/toolbar-sprite-06.png);
  outline: 0;
  height: 33px;
  width: 33px;
  display: inline-block;
  letter-spacing: normal;
  word-spacing: normal;
  background-position: -23px -66px;
}

.disabled a{
  cursor: default;
}

.separator{
  width: 19px;
  height: 33px;
  background-image: url(toolbar/toolbar-sprite-06.png);
  background-position: -3px 0;
  display: inline-block;
  letter-spacing: normal;
  word-spacing: normal;
}

.icon-like{
  padding: 0 6px 0 0;
  display: inline-block;
  letter-spacing: normal;
  word-spacing: normal;
vertical-align: middle;
  height: 48px;
}

.icon-like select{
  width: 9em;
  font-family: tahoma,verdana,arial,helvetica,sans-serif;
}

.icon-like input{
  font-family: tahoma,verdana,arial,helvetica,sans-serif;
}

a.menu-like{
  padding: .3em .4em;
  color: black;
  text-decoration: none;
  white-space: nowrap;
display: block;
}

.menu-like:hover{
  background-color: #ccc;
  background-color: #fff;
}

#hints{
  float: right;
  padding: 1.2em .4em 0;
  padding: .9em 0;
  margin-right: 22px;
}

#hints label{
  font-weight: normal;
}

#hints.selected label{
  background-image: url(content_files/header-hint-07.png);
  background-repeat: repeat-x;
  background-position: left bottom;  
  padding-bottom: .3em;
}

#icon-set{
  padding-right: 10em;
}

#toolbar-undo a                   { background-position: -518px 0; }
#toolbar-undo.disabled a          { background-position: -518px -33px; }
#toolbar-undo.hovered a           { background-position: -518px -66px; }
#toolbar-undo.selected a          { background-position: -518px -99px; }
#toolbar-redo a                   { background-position: -287px 0; }
#toolbar-redo.disabled a          { background-position: -287px -33px; }
#toolbar-redo.hovered a           { background-position: -287px -66px; }
#toolbar-redo.selected a          { background-position: -287px -99px; }
#toolbar-bold a                   { background-position: -56px 0; }
#toolbar-bold.disabled a          { background-position: -56px -33px; }
#toolbar-bold.hovered a           { background-position: -56px -66px; }
#toolbar-bold.selected a          { background-position: -56px -99px; }
#toolbar-italics a                { background-position: -155px 0; }
#toolbar-italics.disabled a       { background-position: -155px -33px; }
#toolbar-italics.hovered a        { background-position: -155px -66px; }
#toolbar-italics.selected a       { background-position: -155px -99px; }
#toolbar-underline a              { background-position: -485px 0; }
#toolbar-underline.disabled a     { background-position: -485px -33px; }
#toolbar-underline.hovered a      { background-position: -485px -66px; }
#toolbar-underline.selected a     { background-position: -485px -99px; }
#toolbar-superscript a            { background-position: -419px 0; }
#toolbar-superscript.disabled a   { background-position: -419px -33px; }
#toolbar-superscript.hovered a    { background-position: -419px -66px; }
#toolbar-superscript.selected a   { background-position: -419px -99px; }
#toolbar-subscript a              { background-position: -386px 0; }
#toolbar-subscript.disabled a     { background-position: -386px -33px; }
#toolbar-subscript.hovered a      { background-position: -386px -66px; }
#toolbar-subscript.selected a     { background-position: -386px -99px; }
#toolbar-link a                   { background-position: -188px 0; }
#toolbar-link.disabled a          { background-position: -188px -33px; }
#toolbar-link.hovered a           { background-position: -188px -66px; }
#toolbar-link.selected a          { background-position: -188px -99px; }
#toolbar-unlink a                 { background-position: -551px 0; }
#toolbar-unlink.disabled a        { background-position: -551px -33px; }
#toolbar-unlink.hovered a         { background-position: -551px -66px; }
#toolbar-unlink.selected a        { background-position: -551px -99px; }
#toolbar-unorderedlist a          { background-position: -584px 0; }
#toolbar-unorderedlist.disabled a { background-position: -584px -33px; }
#toolbar-unorderedlist.hovered a  { background-position: -584px -66px; }
#toolbar-unorderedlist.selected a { background-position: -584px -99px; }
#toolbar-orderedlist a            { background-position: -254px 0; }
#toolbar-orderedlist.disabled a   { background-position: -254px -33px; }
#toolbar-orderedlist.hovered a    { background-position: -254px -66px; }
#toolbar-orderedlist.selected a   { background-position: -254px -99px; }
#toolbar-table a                  { background-position: -452px 0; }
#toolbar-table.disabled a         { background-position: -452px -33px; }
#toolbar-table.hovered a          { background-position: -452px -66px; }
#toolbar-table.selected a         { background-position: -452px -99px; }
#toolbar-image a                  { background-position: -122px 0; }
#toolbar-image.disabled a         { background-position: -122px -33px; }
#toolbar-image.hovered a          { background-position: -122px -66px; }
#toolbar-image.selected a         { background-position: -122px -99px; }
#toolbar-math a                   { background-position: -221px 0; }
#toolbar-math.disabled a          { background-position: -221px -33px; }
#toolbar-math.hovered a           { background-position: -221px -66px; }
#toolbar-math.selected a          { background-position: -221px -99px; }

#toolbar-table.selected a{
  box-shadow: 2px 2px 2px #aaa;
}

#editor-mode{
  font-size: .85em;
  position: relative;
  z-index: 2;
  height: 30px;
background-color: #666;
display: none;
}

#editor-mode ul, #editor-mode li{
  margin: 0;
  padding: 0;
  display: block;
}

#editor-mode ul{
  position: absolute;
  right: 17px;
  bottom: 0;
}

#editor-mode li{
  float: right;
  padding: .35em 0 .4em;
}

#editor-mode a{
  padding: .5em 1em;
  padding: .35em 1em .4em;
  border: 1px solid #aaa;
  background-color: #eee;
  background-color: #ccc;
  text-decoration: none;
  color: black;
  outline: 0;
  margin-left: -1px;
  color: #666;
font-weight: bold;
}

#editor-mode a:hover{
  color: #000;
}

#editor-mode .current a{
  color: black;
  cursor: default;
  background-color: #fff;
  border-bottom: 1px solid #fff;
  font-weight: bold;
}

#sidebar{
  float: left;
  position: fixed;
  margin: 1em 25px;
  margin: 0 25px 1em;
  width: 200px;
  font-family: tahoma,verdana,arial,helvetica,sans-serif;
}

#sidebar dl{
  background-color: #eee;
  margin: 0 0 15px;
  padding: 0;
  border: 1px solid #aaa;
  box-shadow: 0px 0px 5px #9f9f9f;
  box-shadow: 0px 0px 5px #aaa;
  box-shadow: 0px 0px 5px #bbb;
background-color: transparent;
box-shadow: none;
border-width: 0;
}

#sidebar dt{
  margin: 0;
  font-weight: bold;
/*
  background-image: url(toolbar/toolbar-bg-01.png);
  background-repeat: repeat-x;
  background-position: 0 0;
  background-color: #999;
  background-color: #666;
  background-color: #888;
  border-bottom: 1px solid #333;
*/
  border-bottom: 1px solid #666;
  border-bottom: 1px solid #999;
  color: white;
  color: #000;
/*
margin-bottom: .5em;
border-radius: .5em;
*/
/*
border-top-left-radius: .5em;
border-top-right-radius: .5em;
*/
  font-family: tahoma,verdana,arial,helvetica,sans-serif;
  font-weight: normal;
  font-size: 1.3em;
  margin-top: 0;
/*
  padding: .3em .7em;
*/
  padding: 0 0 .1em;
  margin-bottom: .5em;
}

#sidebar dt a{
  text-decoration: none;
  color: black;
  color: white;
  display: block;
  padding: .25em .5em;
  padding: .25em 1.5em .25em .5em;
  background-image: url(toolbar/arrow-down-white-02.png);
  background-repeat: no-repeat;
  background-position: right .35em;
}

#sidebar dd{
  margin: 0;
/*
  padding: .5em 1em;
padding: .75em .75em !important;
  background-color: #ccc;
  background-color: #eee;
background-color: transparent;
background-color: #ddd;
border: 1px solid #999;
*/
border-top-width: 0;
/*
border-bottom-left-radius: .5em;
border-bottom-right-radius: .5em;
*/
}

#artboard{
  overflow: auto;
}

#canvas{
  margin: 1em 25px 2em 250px;
  background-color: #fff;
  border: 1px solid #aaa;
  padding: 2em;
padding: 30px;
  box-shadow: 0px 0px 10px #9f9f9f;
  cursor: text;
  min-height: 100%;
position: relative;
}



/* =============== from earlier mock-ups (edited) ================ */


.example, .definition .example, .rule .example, #canvas .note{
  margin: 0;
  padding: 0;
}

#canvas .note{
  border-color: transparent;
}

.canvas-wrap{
  margin: 1em -20px;
  margin: 1em -10px 1em -10px;
}

.canvas-wrap .canvas-wrap{
  padding-left: 0;
  padding-right: 0;
  margin: 0 .5em 0 1em;
margin: 0 .5em 0 0;
margin: 0 .5em 0 -10px;
margin: 0 -36px 0 -11px;
}

.canvas{
  border: 1px solid transparent;
}
#canvas .canvas-hovered{ /* #canvas ancestor only for override issues */
  border-color: #bbb #ccc;
  border-color: #c8c8c8;
  border-style: dotted;
}

.solution.canvas, .proof.canvas, .statement{
  margin-left: 1.5em;
margin-left: 0;
}

.canvas-inner{
  position: relative;
  min-height: 35px;
  padding: .5em;
  padding-left: .75em;
  padding: .5em 1em;
  padding: .5em 30px .5em .75em;
  padding: .5em 25px .5em 20px;
  padding: .5em 25px .5em 10px;
  padding: .5em 35px .5em 10px;
}

/*
.active{
  border: 1px dotted #bbb !important;
  background-image: url('source-files/cursor-01.gif');
  background-repeat: no-repeat;
  background-position: .75em 1em;
}
*/

.equation-number{
  right: 1em;
  top: 40%;
  right: 30px;
  right: 25px;
}

.canvas-buddy{
  position: absolute;
  left: 47%;
  top: -4px;
  height: 13px;
  width: 50px;
  cursor: url(content_files/openhand.cur), default;
  display: none;
  overflow: hidden;
}

.dragging{
  cursor: url(content_files/closedhand.cur), default !important;
}

.canvas-buddy a{
}

.canvas-buddy img{
  display: block;
}

/*
.nodrag{
  cursor: not-allowed !important;
}

.nodrag img{
  opacity: .5;
}
*/

.canvas-buddy-2{
  position: absolute;
  top: 0;
  left: auto;
  right: 0;
  display: none;
  height: 100%;
  background-color: #f7f7f7;
  border-left: 1px solid #ddd;
  width: 19px;
}

.canvas-buddy a, .canvas-buddy-2 a{
  text-decoration: none;
}

.section-header{
  position: relative;
  padding: 0;
  border-width: 0;
}

.cth-list-item{
  color: #369;
}

.cth-list-h2{
  letter-spacing: -1px;
}

h3.section-header, .cth-list-h3{
  font-size: 1.25em !important;
  letter-spacing: normal;
}

h4.section-header, .cth-list-h4{
  font-size: 1em !important;
  letter-spacing: normal;
}

.cth-list-regular{
  color: #000;
  letter-spacing: normal;
}

.remove-element{
  position: absolute;
  top: 1px;
  left: 1px;
  cursor: pointer;
  right: 15px;
}
.drag-element{
/*
cursor: move;
cursor: grab;
cursor: -moz-grab;
cursor: -webkit-grab;
cursor: url(https://mail.google.com/mail/images/2/openhand.cur), grab, -moz-grab, -webkit-grab, move, default;
*/
cursor: url(content_files/openhand.cur), default;
}
/*
.nodrag .drag-element{
  cursor: not-allowed;
}
*/
.edit-element{
  position: absolute;
  top: 25px;
  cursor: pointer;
  padding: 2px;
left: 1px;
  height: 13px;
  width: 13px;
  height: 14px;
  width: 14px;
  overflow: hidden;
}
.edit-element img{
  width: 13px;
  height: 13px;
  width: 14px;
  height: 14px;
  float: left;
}

.to-remove *{
  color: #999 !important;
  color: #bbb !important;
  background-color: transparent !important;
}
.to-remove .edhint, .to-remove .table table, .to-remove .table td, .to-remove .table th{
  border-color: #bbb !important;
}
.to-remove table{
  border-color: #bbb !important;
}

.to-remove img{
  opacity: .25;
}
.to-remove .remove-element img{
  opacity: 1;
}


tr td.current-cell, tr th.current-cell{
  background-image: url("content_files/test-server-background.png") !important;
  background-color: #E5EEF5;  
}

.table-to-remove img{
  opacity: .25;
}
td.table-to-remove, th.table-to-remove, 
tr.table-to-remove td, tr.table-to-remove th{
  color: #bbb;
  background-image: url("content_files/delete-table-element-01.png");
  background-color: #888 !important;
}

.add-row-before{
  border-top: 15px solid #C5DAE9;
}
.add-row-after{
  border-bottom: 15px solid #C5DAE9;
}
th.add-column-before, td.add-column-before{
  border-left: 30px solid #C5DAE9 !important;
}
th.add-column-after, td.add-column-after{
  border-right: 30px solid #C5DAE9 !important;
}



.active>div>.canvas-buddy, .active>div>.canvas-buddy-2{
  display: block;
/*
  border-style: solid;
  border-color: #999;
  background-color: #ddd;
  border-style: solid;
*/
/*
  opacity: .5;
*/
}
/*
.active>div>.canvas-buddy{
  opacity: .75;
}
.active>div>.canvas-buddy:hover, .active>div>.canvas-buddy-2:hover{
  opacity: 1;
}
*/

#canvas .section-header, .cth-list-h2{
  font-size: 1.65em;
}
#canvas .section .section .section-header, .cth-list-h3{
  font-size: 1.25em;
}

.cnx_label{
  cursor: default;
}

.dragged .cnx_label{
  font-size: .65em !important;
}

.exercise{
  margin: 0;
  padding: 0;
}

.add-solution{
  margin: -.5em 20px 1em 3em;
  margin: -.5em 20px 1em 3em;
  margin: -1.5em 20px .5em 3em;
  margin: 0 0 .5em 2em;
  border: 1px dashed #ccc;
  padding: .5em 1em;
  padding: .2em .5em;
  cursor: text;
visibility: hidden;
}

#canvas .add-solution a{
  color: #888;
  text-decoration: none;
  cursor: text;
}

.add-answer,
.add-solution-2{
  margin: 0 0 .5em 3em;
margin: 0 0 .5em;
  border: 1px dashed #ccc;
  padding: .2em .5em;
  cursor: text;
  display: none;
}

#canvas .add-solution-2 a, #canvas .add-answer a, .hint-text, .math-source-hint-text{
  color: #888;
  text-decoration: none;
  cursor: text;
  font-style: italic;
  font-weight: normal;
}

.MathJax .hint-text{
  cursor: default;
}

.math-source-hint-text{
  font-family: tahoma;
}

.drag{
  position: absolute;
  margin-top: 0;
  margin-left: 680px;
  width: 150px;
  border: 1px solid #bbb;
  border-left-width: 0;
  z-index: 3;
  background-color: #f2f2f2;
  padding: 10px;
}

.drag ul, .drag li{
  margin: 0;
  padding: 0;
  list-style: none;
  float: left;
}

.drag ul a{
  width: 55px;
  text-decoration: none;
  border-radius: 4px;
  border: 1px solid #ccc;
  margin: .5em .5em 0em 0;
  display: block;
  padding: .25em .5em;
  background-color: #e3e3e3;
  color: #000;
cursor: url(content_files/openhand.cur), default;
}

.drag ul a:hover{
  background-color: #fff;
}

.drag h2{
  font-size: 1.15em;
  margin-bottom: .25em;
  color: #666;
}

.drag .help{
  float: right;
}

.add-glossary{
  clear: both;
  font-size: .9em;
  padding-top: .5em;
}

.add-glossary span{
  clear: both;
  margin-top: .5em;
  border-top: 1px solid #bbb;
  padding-top: .75em;
  display: block;
}

/* ============== end earlier mock-ups =============== */

#pedagog ul, #pedagog li, #pedagog dd{
  padding:  0;
  margin: 0;
  list-style-type: none;
  clear: right;
}

/*
#pedagog dd{
  margin-left: 1em;
}
*/

#pedagog .node, #pedagog .pedagog-glossary{
  padding: .5em;
  display: block;
  background-color: #eee;
  border-bottom: 1px solid #999;
  text-decoration: none;
  color: black;
border-radius: 7px;
border: 1px solid #999;
margin-bottom: .25em;
padding-left: .75em;
}

#pedagog .node{
cursor: url(content_files/openhand.cur), default;
}

.plus{
  visibility: visible;
  color: #999;
  display: none;
}

#pedagog .hovered .node{
  background-color: #C5DAE9;
}
#pedagog .hovered .count{
  background-color: #DFE7EC;
}

#pedagog node.pedagog-click{
  background-color: #Ccc;
}

#pedagog .count{
  float: right;
/*
  padding: .5em 0;
*/
  color: #666;
  font-size: 1em;
  background-color: #eee;
  border-left: 1px dotted #bbb;
  position: relative;
border: 1px solid #999;
  border-left: 1px dotted #bbb;
border-top-right-radius: 7px;
border-bottom-right-radius: 7px;
}

#pedagog .count-total{
  text-decoration: none;
  color: #000;
  padding: .5em;
  float: right;
padding: .5em;
}

#pedagog .count-total-hover{
  background-color: #555;
  color: white;
  border: 1px solid #555;
  margin-top: -1px;
  margin-left: -1px;
}

.zero{
  display: none;
}

.count-arrow{
  background-image: url(helper_files/gray-arrow-01.png);
  background-repeat: no-repeat;
  background-position: 100% center;
  position: absolute;
  left: 100%;
  top: -1px;
  z-index: 451;
}

.node-list{
  display: none;
  position: absolute;
  left: 100%;
  top: -1px;
  background-color: white;
  white-space: nowrap;
  padding: .75em 1.5em;
  border: 1px solid #aaa;
  box-shadow: 0px 0px 5px #aaa;
  box-shadow: 2px 2px 5px -2px #aaa;
  z-index: 450;
}

.node-list a{
  color: #369;
}

.node-list strong{
  color: black;
  display: block;
  margin-bottom: .5em;
}

.pedagog-glossary{
  background-color: #e3e3e3 !important;
  cursor: default;
background-color: transparent !important;
border-width: 0 !important;
padding: .5em 0 0 !important;
}

.glossary-container{
  display: none;
}

dfn.term.edhint{
  border-bottom: 2px dotted #6c6;
  border-bottom: 2px dotted #e70;
  border-bottom: 2px dotted #f90;
  border-bottom: 2px dotted #fc0;
  border-bottom: 3px dotted #d9f;
  border-bottom: 3px dotted #6c6;
}

em.emphasis.edhint{
/*
  border-bottom: 1px dashed #999;
  border-bottom: 2px dotted #333;
  border-bottom: 2px dotted #6c6;
  border-bottom: 3px dotted #6c6;
*/
}

.convert-to-header em.emphasis, .section-header .title{
  display: inline-block;
  position: relative;
}

em.emphasis .edhint, .section-header .edhint{
  width: 100%;
  height: 15px;
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 3;
/*
  border-bottom: 1px dashed #FF9900;
*/
  background-image: url(content_files/header-hint-07.png);
  background-repeat: repeat-x;
  background-position: left 1px;
  cursor: default;
}

.convert-to-header .edhint img, .title .edhint img{
  float: right;
  margin-top: -1px;
  margin-top: 1px;
  margin-right: -7px;
  margin-right: -5px;
}

/*
.em.emphasis.edhinted{
  box-shadow: 3px 3px 3px #eee;
  display: inline-block;
}
*/

.cth-list, .cth-list li{
  display: block;
  padding: 0;
  margin: 0 !important;
  list-style-type: none;
  white-space: nowrap;
}
.cth-list{
  position: absolute;
  z-index: 4;
  top: 100%;
  left: 0;
  margin-top: 1px !important;
  padding: .3em !important;
  background-color: #fff;
  border: 1px solid #999;
  min-width: 100%;
/*
  box-shadow: 3px 3px 3px #eee;
*/
  background-color: #fff;
  /* undo effects of ancestors */
  font-weight: normal;
  color: black;
  letter-spacing: normal;
}
h2 .cth-list{
  font-size: .6em;
}
h3 .cth-list{
  font-size: .8em;
}
h4 .cth-list{
  font-size: 1em;
}
.cth-level{
  display: block;
}
li.cth-list-item{
  border: 1px solid #ccc;
  margin-top: -1px !important;
  padding: .2em .5em;
  font-weight: bold;
  padding-left: 7px;
padding: .5em 30px;
  cursor: pointer;
  background-color: #E5EEF5;
  white-space: nowrap;
}
/*
li.cth-list-h3{
  padding-left: 40px;
}
li.cth-list-h4{
  padding-left: 50px;
}
*/
.cth-list .section-header{
/*
  display: inline;
*/
}

li.cth-list-item:hover{
  background-color: #C5DAE9;
  border-color: #1B86D2;